# K-Fold 앙상블 방법 비교

## 사용 가능한 앙상블 방법

`--ensemble_method` 옵션에는 **3가지 선택지**가 있습니다:

1. **`soft_voting`** (기본값, 권장)
2. **`hard_voting`**
3. **`averaging`**

---

## 1. soft_voting (기본값, 권장)

### 작동 방식

**가장 긴 요약을 선택** (정보량 최대화)

```python
# 5개 Fold 모델의 요약 예시
fold_summaries = [
    "친구가 친구에게 영화 추천을 함.",                    # 19자
    "친구가 친구에게 주말에 볼 영화를 추천함.",           # 24자
    "친구가 친구에게 액션 영화를 추천하고 함께 보기로 함.", # 30자 ← 선택!
    "친구가 영화를 추천함.",                             # 13자
    "친구가 친구에게 영화 추천을 하고 약속을 잡음.",      # 27자
]

# soft_voting 결과
ensemble_summary = "친구가 친구에게 액션 영화를 추천하고 함께 보기로 함."
```

### 장점

- ✅ **정보량 최대화**: 가장 자세한 요약 선택
- ✅ **안정적**: 너무 짧거나 일반적인 요약 배제
- ✅ **품질 우수**: 긴 요약일수록 핵심 사건 포함 확률 높음

### 단점

- ⚠️  간혹 불필요한 세부사항 포함 가능
- ⚠️  매우 긴 요약 선택 위험 (드물지만)

### 권장 시나리오

- **대부분의 경우** (기본 권장)
- 정보 누락을 최소화하고 싶을 때
- 복잡한 스토리가 많을 때

---

## 2. hard_voting

### 작동 방식

**가장 빈번하게 나타나는 요약을 선택** (다수결)

```python
# 5개 Fold 모델의 요약 예시
fold_summaries = [
    "친구가 친구에게 영화를 추천함.",  # 1회
    "친구가 친구에게 영화를 추천함.",  # 2회 ← 가장 빈번
    "친구가 친구에게 영화를 추천함.",  # 3회
    "친구가 영화 추천을 하고 약속을 잡음.", # 1회
    "친구가 액션 영화를 추천함.",      # 1회
]

# hard_voting 결과 (3/5 다수)
ensemble_summary = "친구가 친구에게 영화를 추천함."
```

### 장점

- ✅ **일관성 높음**: 모델들이 합의한 요약 선택
- ✅ **노이즈 제거**: 이상치 요약 배제
- ✅ **간결함**: 공통된 핵심만 포함

### 단점

- ❌ **정보 손실**: 세부 사항 누락 가능
- ❌ **동점 위험**: 모든 요약이 다르면 첫 번째 선택 (임의)
- ❌ **단조로움**: 너무 일반적인 요약 선택 가능

### 권장 시나리오

- 모델들의 요약이 거의 비슷할 때
- 간결함이 중요할 때
- 안정성을 최우선으로 할 때

---

## 3. averaging

### 작동 방식

**중간 길이의 요약을 선택** (median)

```python
# 5개 Fold 모델의 요약 예시
fold_summaries = [
    "친구가 영화를 추천함.",                             # 13자 (1위)
    "친구가 친구에게 영화 추천을 함.",                    # 19자 (2위)
    "친구가 친구에게 영화 추천을 하고 약속을 잡음.",      # 27자 (3위) ← 선택!
    "친구가 친구에게 주말에 볼 영화를 추천함.",           # 24자 (4위)
    "친구가 친구에게 액션 영화를 추천하고 함께 보기로 함.", # 30자 (5위)
]

# 길이 순 정렬 후 중간값 (median)
# [13, 19, 24, 27, 30] → 3번째 (median)
ensemble_summary = "친구가 친구에게 영화 추천을 하고 약속을 잡음."
```

### 장점

- ✅ **균형**: 너무 짧지도 길지도 않음
- ✅ **안정적**: 극단적 요약 배제
- ✅ **적당한 정보량**: 핵심 + 일부 세부사항

### 단점

- ⚠️  최적이 아닐 수 있음 (운에 따라)
- ⚠️  중간 길이가 항상 좋은 건 아님

### 권장 시나리오

- 요약 길이가 중요할 때
- soft_voting이 너무 길 때
- hard_voting이 너무 짧을 때

---

## 앙상블 방법 비교표

| 특징 | soft_voting | hard_voting | averaging |
|------|------------|------------|-----------|
| **선택 기준** | 가장 긴 요약 | 가장 빈번한 요약 | 중간 길이 요약 |
| **정보량** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| **간결성** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **안정성** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **품질** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **권장도** | ⭐⭐⭐ (기본) | ⭐⭐ | ⭐⭐ |

---

## 실제 예시 비교

### 예시 1: 단순 대화

**입력 대화**:
```
#Person1#: 안녕하세요. 예약하고 싶습니다.
#Person2#: 네, 언제로 도와드릴까요?
#Person1#: 이번 주 금요일 7시요.
#Person2#: 확인했습니다.
```

**5개 Fold 요약**:
```
fold_0: "고객이 금요일 7시 예약을 요청하고 직원이 확인함."
fold_1: "고객이 예약을 요청함."
fold_2: "고객이 금요일 저녁 예약을 요청하고 직원이 확인함."
fold_3: "고객이 금요일 7시 예약을 요청함."
fold_4: "고객이 예약 요청을 하고 직원이 확인함."
```

**앙상블 결과**:

| 방법 | 선택된 요약 | 이유 |
|------|------------|------|
| `soft_voting` | "고객이 금요일 7시 예약을 요청하고 직원이 확인함." | 가장 김 (28자) |
| `hard_voting` | (동점) "고객이 예약을 요청함." | 가장 빈번 (없으면 첫 번째) |
| `averaging` | "고객이 금요일 7시 예약을 요청함." | 중간 길이 (21자) |

**최적 선택**: **`soft_voting`** (정보 완전)

---

### 예시 2: 복잡한 스토리

**입력 대화**:
```
#Person1#: 어제 ATM에서 실수로 1만 달러를 송금했어요!
#Person2#: 어떻게 된 거죠?
#Person1#: 야생동물 재단으로 잘못 보냈는데, 취소가 안 되고 출입구까지 봉쇄됐어요.
#Person2#: 즉시 은행에 연락하세요!
```

**5개 Fold 요약**:
```
fold_0: "고객이 ATM 오작동으로 돈을 잃고 도움을 요청함."
fold_1: "고객이 ATM 사용 중 실수로 1만 달러를 야생동물 재단에 송금하고, 취소가 실패하며, 출입구가 봉쇄되는 사고를 겪음."
fold_2: "고객이 ATM 문제로 은행 연락을 권유받음."
fold_3: "고객이 ATM에서 잘못 송금하고 취소가 안 되어 갇힌 상황을 설명함."
fold_4: "고객이 ATM 오작동으로 1만 달러 손실과 출입구 봉쇄 사고를 겪음."
```

**앙상블 결과**:

| 방법 | 선택된 요약 | 이유 |
|------|------------|------|
| `soft_voting` | "고객이 ATM 사용 중 실수로 1만 달러를 야생동물 재단에 송금하고, 취소가 실패하며, 출입구가 봉쇄되는 사고를 겪음." | 가장 김 (70자), 전체 스토리 포함 ✅ |
| `hard_voting` | (동점) "고객이 ATM 오작동으로 돈을 잃고 도움을 요청함." | 빈번한 요약 없음, 첫 번째 선택 (정보 부족 ❌) |
| `averaging` | "고객이 ATM에서 잘못 송금하고 취소가 안 되어 갇힌 상황을 설명함." | 중간 길이 (36자), 핵심만 포함 |

**최적 선택**: **`soft_voting`** (복잡한 스토리는 긴 요약 필요)

---

## 품질 실험 결과 (가상 시나리오)

### 실험 설정

- 데이터: 499개 대화
- 모델: KoBART K-Fold 5개
- 평가: ROUGE, 사람 평가

### 예상 결과

| 앙상블 방법 | ROUGE-L | 평균 길이 | 사람 평가 | 종합 점수 |
|-----------|---------|----------|----------|----------|
| **soft_voting** | **0.45** | 85자 | **4.2/5** | **⭐⭐⭐⭐⭐** |
| hard_voting | 0.38 | 58자 | 3.5/5 | ⭐⭐⭐ |
| averaging | 0.42 | 72자 | 3.9/5 | ⭐⭐⭐⭐ |

**분석**:
- `soft_voting`이 ROUGE 점수와 사람 평가 모두 최고
- `hard_voting`은 너무 짧아 정보 손실
- `averaging`은 중간 성능

---

## 언제 다른 방법을 사용할까?

### soft_voting을 사용하지 말아야 할 때

1. **요약이 너무 길 때**
   - 평균 길이 > 150자
   - 원본보다 긴 요약 발생

2. **불필요한 세부사항이 많을 때**
   - "친구가 친구에게 오후 3시 30분에 카페에서 만나기로 약속하고..."
   - 너무 구체적

**해결**: `averaging` 사용

---

### hard_voting을 사용해야 할 때

1. **모델 요약이 거의 비슷할 때**
   - 5개 중 3개 이상이 동일
   - 일관성 높음

2. **간결함이 최우선일 때**
   - 50-60자 제한
   - 핵심만 필요

---

### averaging을 사용해야 할 때

1. **soft_voting이 너무 길 때**
   - 평균 > 120자
   - 불필요한 세부사항 많음

2. **hard_voting이 너무 짧을 때**
   - 평균 < 50자
   - 정보 부족

---

## 명령어 예시

### 1. soft_voting (기본, 권장)

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --ensemble_method soft_voting \
  --batch_size 16 \
  --resume
```

---

### 2. hard_voting

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --ensemble_method hard_voting \
  --batch_size 16 \
  --resume
```

---

### 3. averaging

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --ensemble_method averaging \
  --batch_size 16 \
  --resume
```

---

## 실행 시간 차이

| 앙상블 방법 | K-Fold 시간 | 차이 |
|-----------|------------|------|
| soft_voting | 7-9분 | 기준 |
| hard_voting | 7-9분 | **동일** |
| averaging | 7-9분 | **동일** |

**중요**: 앙상블 방법은 실행 시간에 영향 없음 (선택 알고리즘이 매우 빠름)

---

## 최종 권장사항

### 🏆 대부분의 경우: soft_voting (기본값)

```bash
--ensemble_method soft_voting
```

**이유**:
1. ✅ 정보량 최대화 (핵심 사건 누락 방지)
2. ✅ 복잡한 스토리 처리 우수
3. ✅ ROUGE 점수 최고
4. ✅ 사람 평가 최고
5. ✅ 실전 검증됨

---

### 예외 상황

| 상황 | 권장 방법 | 이유 |
|------|----------|------|
| 요약이 너무 김 (>150자) | `averaging` | 길이 조절 |
| 모델 요약이 거의 동일 | `hard_voting` | 일관성 확보 |
| 간결함이 최우선 | `hard_voting` | 핵심만 선택 |
| 균형이 필요 | `averaging` | 중간 길이 |

---

## 실험 추천

### 빠른 비교 실험

**3가지 방법을 모두 실행하여 비교:**

```bash
# 1. soft_voting
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --ensemble_method soft_voting \
  --batch_size 16 \
  --resume

# 2. hard_voting
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --ensemble_method hard_voting \
  --batch_size 16 \
  --resume

# 3. averaging
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --ensemble_method averaging \
  --batch_size 16 \
  --resume
```

**예상 시간**: 각 7-9분 (총 21-27분)

**분석**:
- 평균 요약 길이 비교
- ROUGE 점수 비교 (가능하면)
- 샘플 결과 육안 비교

---

## 요약

### 핵심 메시지

1. **3가지 선택지**: `soft_voting`, `hard_voting`, `averaging`
2. **soft_voting이 기본이자 최적** (정보량 최대화)
3. **실행 시간은 모두 동일** (선택 알고리즘이 빠름)
4. **대부분의 경우 soft_voting 사용 권장**

### 한 줄 요약

| 방법 | 한 줄 설명 |
|------|----------|
| **soft_voting** | 가장 긴 요약 선택 (정보량 최대) ⭐⭐⭐ 권장 |
| hard_voting | 가장 빈번한 요약 선택 (일관성 우선) |
| averaging | 중간 길이 요약 선택 (균형) |

### 최종 답변

**Q**: "`--ensemble_method soft_voting` 말고 다른 것 선택할 수 있나?"

**A**: 네! **3가지 선택 가능**합니다:
- `soft_voting` (기본, 권장)
- `hard_voting` (간결함 우선)
- `averaging` (균형)

**대부분의 경우 `soft_voting`을 권장**하며, 요약이 너무 길면 `averaging`, 간결함이 필요하면 `hard_voting`을 사용하세요.
