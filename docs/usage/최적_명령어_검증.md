# ìµœì  ì¶”ë¡  ëª…ë ¹ì–´ ê²€ì¦

## ì‚¬ìš©ì ì œê³µ ëª…ë ¹ì–´

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --solar_model solar-1-chat \
  --solar_batch_size 5 \
  --solar_temperature 0.3 \
  --solar_batch_size 5 \
  --use_voting \
  --n_samples 5 \
  --solar_delay 3.0 \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --correction_strategy quality_based \
  --correction_threshold 0.3 \
  --max_new_tokens 120 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 32 \
  --ensemble_method soft_voting \
  --resume
```

## ê²€ì¦ ê²°ê³¼

### âœ… ì˜¬ë°”ë¥¸ ë¶€ë¶„

1. **K-Fold ëª¨ë¸ ê²½ë¡œ**: `experiments/20251014/20251014_183206_kobart_ultimate_kfold` âœ…
2. **Solar API í™œì„±í™”**: `--use_solar_api` âœ…
3. **Solar voting í™œì„±í™”**: `--use_voting --n_samples 5` âœ…
4. **HuggingFace ë³´ì • í™œì„±í™”**: `--use_pretrained_correction` âœ…
5. **ë³´ì • ì „ëµ**: `--correction_strategy quality_based` âœ…
6. **ì•™ìƒë¸” ë°©ë²•**: `--ensemble_method soft_voting` âœ…
7. **Resume ê¸°ëŠ¥**: `--resume` (ì²´í¬í¬ì¸íŠ¸ ì¬ì‚¬ìš©) âœ…

### âš ï¸  ìˆ˜ì • í•„ìš”í•œ ë¶€ë¶„

#### 1. ì¤‘ë³µëœ ì¸ì

```bash
--solar_batch_size 5 \   # ì²« ë²ˆì§¸
--solar_batch_size 5 \   # ë‘ ë²ˆì§¸ (ì¤‘ë³µ!)
```

**ë¬¸ì œì **: ë™ì¼í•œ ì¸ìê°€ ë‘ ë²ˆ ë‚˜íƒ€ë‚¨
**í•´ê²°**: í•˜ë‚˜ë§Œ ë‚¨ê¸°ê¸°

---

#### 2. Solar ëª¨ë¸ ì´ë¦„ ì˜¤ë¥˜

```bash
--solar_model solar-1-chat  # âŒ ì˜ëª»ëœ ëª¨ë¸ëª…
```

**ë¬¸ì œì **: Solar APIì˜ ì‹¤ì œ ëª¨ë¸ëª…ì€ `solar-1-mini-chat`
**ìˆ˜ì •**: `--solar_model solar-1-mini-chat`

**ì°¸ê³ **:
- í˜„ì¬ ì½”ë“œì—ì„œ ê¸°ë³¸ê°’ì´ `solar-1-mini-chat`ì´ë¯€ë¡œ ì´ ì¸ìë¥¼ ìƒëµí•´ë„ ë¨
- `solar-1-chat` ëª¨ë¸ì€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ (API ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥)

---

#### 3. Solar ì¸ìëª… ë¶ˆì¼ì¹˜

```bash
--use_voting --n_samples 5     # âŒ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¸ì‹ ë¶ˆê°€
```

**ë¬¸ì œì **: `kfold_ensemble_inference.py`ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜ë¨:
- `--solar_use_voting` (âœ…)
- `--solar_n_samples` (âœ…)

**ìˆ˜ì •**:
```bash
--solar_use_voting \
--solar_n_samples 5 \
```

---

#### 4. ì˜¨ë„ ì¸ìëª…

```bash
--solar_temperature 0.3   # âš ï¸  ìŠ¤í¬ë¦½íŠ¸ì— ì—†ëŠ” ì¸ì
```

**í™•ì¸ í•„ìš”**: `kfold_ensemble_inference.py`ì— `--solar_temperature` ì¸ìê°€ ìˆëŠ”ì§€ í™•ì¸

**ì˜ˆìƒ**: ì•„ë§ˆë„ ì—†ì„ ê²ƒìœ¼ë¡œ ë³´ì„ (Solar API ë‚´ë¶€ì—ì„œ ê¸°ë³¸ê°’ ì‚¬ìš©)

---

#### 5. Rate Limit ëŒ€ë¹„

```bash
--solar_delay 3.0 \        # âœ… ì¢‹ì€ ì„¤ì •
--solar_batch_size 5 \     # âœ… ì¢‹ì€ ì„¤ì •
```

**ì°¸ê³ **:
- voting n=5 ì‚¬ìš© ì‹œ API í˜¸ì¶œ **2,495íšŒ** (499 Ã— 5)
- `delay=3.0` + `batch_size=5` = ì•ˆì „í•œ ì„¤ì •
- ì˜ˆìƒ ì‹œê°„: **100-120ë¶„**

---

#### 6. K-Fold ë°°ì¹˜ í¬ê¸°

```bash
--batch_size 32  # âš ï¸  ë„ˆë¬´ í¼
```

**ë¬¸ì œì **:
- RTX 4090 (24GB) ê¸°ì¤€ìœ¼ë¡œ `batch_size=16`ì´ ì•ˆì „
- `max_new_tokens=120`ìœ¼ë¡œ ê¸´ ìš”ì•½ ìƒì„± ì‹œ ë©”ëª¨ë¦¬ ë¶€ë‹´ ì¦ê°€
- batch_size 32ëŠ” OOM (Out of Memory) ìœ„í—˜

**ê¶Œì¥**: `--batch_size 16` ë˜ëŠ” `--batch_size 8`

---

## ìˆ˜ì •ëœ ìµœì  ëª…ë ¹ì–´

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --solar_model solar-1-mini-chat \
  --solar_batch_size 5 \
  --solar_delay 3.0 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --correction_strategy quality_based \
  --correction_threshold 0.3 \
  --max_new_tokens 120 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

### ì£¼ìš” ë³€ê²½ì‚¬í•­

| í•­ëª© | ì›ë³¸ | ìˆ˜ì • | ì´ìœ  |
|------|------|------|------|
| `--solar_model` | `solar-1-chat` | `solar-1-mini-chat` | ì˜¬ë°”ë¥¸ ëª¨ë¸ëª… |
| `--solar_batch_size` | ì¤‘ë³µ (2íšŒ) | 1íšŒë§Œ | ì¤‘ë³µ ì œê±° |
| `--use_voting` | `--use_voting` | `--solar_use_voting` | ì˜¬ë°”ë¥¸ ì¸ìëª… |
| `--n_samples` | `--n_samples 5` | `--solar_n_samples 5` | ì˜¬ë°”ë¥¸ ì¸ìëª… |
| `--solar_temperature` | `0.3` | ì œê±° | ìŠ¤í¬ë¦½íŠ¸ì— ì—†ìŒ (í™•ì¸ í•„ìš”) |
| `--batch_size` | `32` | `16` | OOM ë°©ì§€ |
| `--length_penalty` | `1` | `1.0` | ëª…ì‹œì  float |

---

## ì˜ˆìƒ ì‹¤í–‰ ì‹œê°„

### ë‹¨ê³„ë³„ ì†Œìš” ì‹œê°„

1. **K-Fold ì•™ìƒë¸”** (--resumeìœ¼ë¡œ ê±´ë„ˆëœ€): **0ë¶„**
2. **HuggingFace ë³´ì •**: ì•½ **5-10ë¶„**
3. **Solar API voting 5íšŒ**: ì•½ **90-120ë¶„**
   - 499ê°œ ëŒ€í™” Ã— 5íšŒ = 2,495 API í˜¸ì¶œ
   - ë°°ì¹˜ 5ê°œ Ã— 3ì´ˆ delay = ë§¤ìš° ì•ˆì „
   - ë‚´ë¶€ ìƒ˜í”Œ ê°„ 2ì´ˆ ëŒ€ê¸° (ìë™)

**ì´ ì˜ˆìƒ ì‹œê°„**: **95-130ë¶„ (1.5-2ì‹œê°„)**

---

## ì¶”ê°€ ê¶Œì¥ì‚¬í•­

### 1. ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§

```bash
# ë³„ë„ í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰
watch -n 5 nvidia-smi
```

ë§Œì•½ `batch_size=16`ì—ì„œë„ OOM ë°œìƒ ì‹œ:
- `--batch_size 8`ë¡œ ê°ì†Œ
- `--max_new_tokens 100`ìœ¼ë¡œ ê°ì†Œ

### 2. í”„ë¡œì„¸ìŠ¤ ìš°ì„ ìˆœìœ„

í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ë“¤ì„ ì¢…ë£Œí•˜ê³  ì´ ëª…ë ¹ì–´ë§Œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ê¶Œì¥:

```bash
# ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
ps aux | grep kfold_ensemble_inference

# í•„ìš”ì‹œ ì¢…ë£Œ (PID í™•ì¸ í›„)
kill <PID>
```

### 3. Rate Limit ì—¬ìœ 

`--solar_delay 3.0`ì€ ë§¤ìš° ì•ˆì „í•œ ì„¤ì •ì´ì§€ë§Œ, ë§Œì•½ 429 ì—ëŸ¬ê°€ ê³„ì† ë°œìƒí•˜ë©´:

```bash
--solar_delay 5.0 \
--solar_batch_size 3 \
```

ì´ ê²½ìš° ì‹œê°„ì´ ë” ëŠ˜ì–´ë‚¨ (150-180ë¶„)

---

## ìµœì¢… ê²°ë¡ 

### âœ… ìˆ˜ì •ëœ ëª…ë ¹ì–´ ì‚¬ìš©

ìœ„ì˜ **ìˆ˜ì •ëœ ìµœì  ëª…ë ¹ì–´**ë¥¼ ì‚¬ìš©í•˜ë©´:

1. **ëª¨ë“  ìµœì‹  ê¸°ëŠ¥ í™œì„±í™”**:
   - âœ… K-Fold ì•™ìƒë¸” (soft voting)
   - âœ… HuggingFace ë³´ì • (quality_based)
   - âœ… Solar API (í”Œë ˆì´ìŠ¤í™€ë” ìë™ ì œê±° í¬í•¨)
   - âœ… Solar voting 5íšŒ (ê³ í’ˆì§ˆ)

2. **ì•ˆì •ì„± ë³´ì¥**:
   - âœ… OOM ë°©ì§€ (batch_size=16)
   - âœ… Rate limit ì•ˆì „ (delay=3.0, batch=5)
   - âœ… Resume ê¸°ëŠ¥ìœ¼ë¡œ ì¤‘ë‹¨ ì‹œ ì¬ê°œ ê°€ëŠ¥

3. **ì˜ˆìƒ í’ˆì§ˆ**:
   - ğŸ† ìµœê³  í’ˆì§ˆì˜ ìš”ì•½ ìƒì„±
   - ğŸ† í”Œë ˆì´ìŠ¤í™€ë” ìë™ ì œê±°
   - ğŸ† test_28 ê°™ì€ ì–´ë ¤ìš´ ì¼€ì´ìŠ¤ë„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬

### â±ï¸  ì˜ˆìƒ ì™„ë£Œ ì‹œê°„

- **ìµœì†Œ**: 95ë¶„
- **í‰ê· **: 110ë¶„
- **ìµœëŒ€**: 130ë¶„
