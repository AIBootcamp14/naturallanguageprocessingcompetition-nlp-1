# 최적 추론 명령어 검증

## 사용자 제공 명령어

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --solar_model solar-1-chat \
  --solar_batch_size 5 \
  --solar_temperature 0.3 \
  --solar_batch_size 5 \
  --use_voting \
  --n_samples 5 \
  --solar_delay 3.0 \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --correction_strategy quality_based \
  --correction_threshold 0.3 \
  --max_new_tokens 120 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 32 \
  --ensemble_method soft_voting \
  --resume
```

## 검증 결과

### ✅ 올바른 부분

1. **K-Fold 모델 경로**: `experiments/20251014/20251014_183206_kobart_ultimate_kfold` ✅
2. **Solar API 활성화**: `--use_solar_api` ✅
3. **Solar voting 활성화**: `--use_voting --n_samples 5` ✅
4. **HuggingFace 보정 활성화**: `--use_pretrained_correction` ✅
5. **보정 전략**: `--correction_strategy quality_based` ✅
6. **앙상블 방법**: `--ensemble_method soft_voting` ✅
7. **Resume 기능**: `--resume` (체크포인트 재사용) ✅

### ⚠️  수정 필요한 부분

#### 1. 중복된 인자

```bash
--solar_batch_size 5 \   # 첫 번째
--solar_batch_size 5 \   # 두 번째 (중복!)
```

**문제점**: 동일한 인자가 두 번 나타남
**해결**: 하나만 남기기

---

#### 2. Solar 모델 이름 오류

```bash
--solar_model solar-1-chat  # ❌ 잘못된 모델명
```

**문제점**: Solar API의 실제 모델명은 `solar-1-mini-chat`
**수정**: `--solar_model solar-1-mini-chat`

**참고**:
- 현재 코드에서 기본값이 `solar-1-mini-chat`이므로 이 인자를 생략해도 됨
- `solar-1-chat` 모델은 존재하지 않음 (API 에러 발생 가능)

---

#### 3. Solar 인자명 불일치

```bash
--use_voting --n_samples 5     # ❌ 스크립트에서 인식 불가
```

**문제점**: `kfold_ensemble_inference.py`에서는 다음과 같이 정의됨:
- `--solar_use_voting` (✅)
- `--solar_n_samples` (✅)

**수정**:
```bash
--solar_use_voting \
--solar_n_samples 5 \
```

---

#### 4. 온도 인자명

```bash
--solar_temperature 0.3   # ⚠️  스크립트에 없는 인자
```

**확인 필요**: `kfold_ensemble_inference.py`에 `--solar_temperature` 인자가 있는지 확인

**예상**: 아마도 없을 것으로 보임 (Solar API 내부에서 기본값 사용)

---

#### 5. Rate Limit 대비

```bash
--solar_delay 3.0 \        # ✅ 좋은 설정
--solar_batch_size 5 \     # ✅ 좋은 설정
```

**참고**:
- voting n=5 사용 시 API 호출 **2,495회** (499 × 5)
- `delay=3.0` + `batch_size=5` = 안전한 설정
- 예상 시간: **100-120분**

---

#### 6. K-Fold 배치 크기

```bash
--batch_size 32  # ⚠️  너무 큼
```

**문제점**:
- RTX 4090 (24GB) 기준으로 `batch_size=16`이 안전
- `max_new_tokens=120`으로 긴 요약 생성 시 메모리 부담 증가
- batch_size 32는 OOM (Out of Memory) 위험

**권장**: `--batch_size 16` 또는 `--batch_size 8`

---

## 수정된 최적 명령어

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --solar_model solar-1-mini-chat \
  --solar_batch_size 5 \
  --solar_delay 3.0 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --correction_strategy quality_based \
  --correction_threshold 0.3 \
  --max_new_tokens 120 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

### 주요 변경사항

| 항목 | 원본 | 수정 | 이유 |
|------|------|------|------|
| `--solar_model` | `solar-1-chat` | `solar-1-mini-chat` | 올바른 모델명 |
| `--solar_batch_size` | 중복 (2회) | 1회만 | 중복 제거 |
| `--use_voting` | `--use_voting` | `--solar_use_voting` | 올바른 인자명 |
| `--n_samples` | `--n_samples 5` | `--solar_n_samples 5` | 올바른 인자명 |
| `--solar_temperature` | `0.3` | 제거 | 스크립트에 없음 (확인 필요) |
| `--batch_size` | `32` | `16` | OOM 방지 |
| `--length_penalty` | `1` | `1.0` | 명시적 float |

---

## 예상 실행 시간

### 단계별 소요 시간

1. **K-Fold 앙상블** (--resume으로 건너뜀): **0분**
2. **HuggingFace 보정**: 약 **5-10분**
3. **Solar API voting 5회**: 약 **90-120분**
   - 499개 대화 × 5회 = 2,495 API 호출
   - 배치 5개 × 3초 delay = 매우 안전
   - 내부 샘플 간 2초 대기 (자동)

**총 예상 시간**: **95-130분 (1.5-2시간)**

---

## 추가 권장사항

### 1. 메모리 모니터링

```bash
# 별도 터미널에서 실행
watch -n 5 nvidia-smi
```

만약 `batch_size=16`에서도 OOM 발생 시:
- `--batch_size 8`로 감소
- `--max_new_tokens 100`으로 감소

### 2. 프로세스 우선순위

현재 실행 중인 다른 프로세스들을 종료하고 이 명령어만 실행하는 것을 권장:

```bash
# 다른 프로세스 확인
ps aux | grep kfold_ensemble_inference

# 필요시 종료 (PID 확인 후)
kill <PID>
```

### 3. Rate Limit 여유

`--solar_delay 3.0`은 매우 안전한 설정이지만, 만약 429 에러가 계속 발생하면:

```bash
--solar_delay 5.0 \
--solar_batch_size 3 \
```

이 경우 시간이 더 늘어남 (150-180분)

---

## 최종 결론

### ✅ 수정된 명령어 사용

위의 **수정된 최적 명령어**를 사용하면:

1. **모든 최신 기능 활성화**:
   - ✅ K-Fold 앙상블 (soft voting)
   - ✅ HuggingFace 보정 (quality_based)
   - ✅ Solar API (플레이스홀더 자동 제거 포함)
   - ✅ Solar voting 5회 (고품질)

2. **안정성 보장**:
   - ✅ OOM 방지 (batch_size=16)
   - ✅ Rate limit 안전 (delay=3.0, batch=5)
   - ✅ Resume 기능으로 중단 시 재개 가능

3. **예상 품질**:
   - 🏆 최고 품질의 요약 생성
   - 🏆 플레이스홀더 자동 제거
   - 🏆 test_28 같은 어려운 케이스도 올바르게 처리

### ⏱️  예상 완료 시간

- **최소**: 95분
- **평균**: 110분
- **최대**: 130분
