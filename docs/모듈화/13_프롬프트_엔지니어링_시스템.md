# 프롬프트 엔지니어링 시스템 상세 가이드

## 📋 목차
1. [개요](#개요)
2. [PromptTemplate 클래스](#prompttemplate-클래스)
3. [PromptLibrary 클래스](#promptlibrary-클래스)
4. [PromptSelector 클래스](#promptselector-클래스)
5. [프롬프트 템플릿 종류](#프롬프트-템플릿-종류)
6. [사용 방법](#사용-방법)
7. [실행 명령어](#실행-명령어)

---

## 📝 개요

### 목적
- Solar API 및 LLM의 성능 극대화
- 대화 특성별 최적 프롬프트 자동 선택
- 토큰 사용량 최소화하면서 품질 유지
- 일관된 출력 형식 보장

### 핵심 기능
- ✅ 16개 사전 정의 프롬프트 템플릿
- ✅ 대화 길이/참여자 수/토큰 예산 기반 동적 선택
- ✅ Zero-shot, Few-shot, Chain-of-Thought 지원
- ✅ 토큰 추정 및 압축 템플릿
- ✅ 커스텀 템플릿 추가 지원

---

## 🎯 PromptTemplate 클래스

### 파일 위치
```
src/prompts/template.py
```

### 클래스 구조

```python
@dataclass
class PromptTemplate:
    name: str              # 템플릿 이름
    template: str          # 프롬프트 문자열
    description: str       # 설명
    category: str          # 카테고리
    variables: List[str]   # 필수 변수 목록

    def format(**kwargs) -> str  # 템플릿 포맷팅
```

### 사용 예시

```python
from src.prompts import PromptTemplate

# 템플릿 생성
template = PromptTemplate(
    name="custom_summary",
    template="""다음 대화를 요약해주세요:

{dialogue}

요약 ({style} 스타일):""",
    description="스타일 지정 가능한 템플릿",
    category="custom",
    variables=["dialogue", "style"]
)

# 템플릿 포맷팅
prompt = template.format(
    dialogue="A: 안녕 B: 안녕",
    style="간결한"
)

print(prompt)
# 출력:
# 다음 대화를 요약해주세요:
#
# A: 안녕 B: 안녕
#
# 요약 (간결한 스타일):
```

---

## 📚 PromptLibrary 클래스

### 기능

- 16개 기본 프롬프트 템플릿 관리
- 템플릿 조회, 추가, 분류
- 토큰 수 추정

### 주요 메서드

```python
class PromptLibrary:
    def get_template(name: str) -> PromptTemplate
    def add_template(template: PromptTemplate)
    def list_templates(category: Optional[str]) -> List[str]
    def get_templates_by_category(category: str) -> List[PromptTemplate]
    def estimate_tokens(template_name: str, **kwargs) -> int
```

### 사용 예시

```python
from src.prompts import PromptLibrary

# 라이브러리 생성
library = PromptLibrary()

# 템플릿 조회
template = library.get_template('zero_shot_basic')

# 카테고리별 목록
zero_shot_templates = library.list_templates(category='zero_shot')
print(zero_shot_templates)
# ['zero_shot_basic', 'zero_shot_detailed', 'zero_shot_structured']

# 템플릿 포맷팅
dialogue = "A: 안녕하세요 B: 안녕하세요"
prompt = template.format(dialogue=dialogue)

# 토큰 추정
tokens = library.estimate_tokens('zero_shot_basic', dialogue=dialogue)
print(f"예상 토큰: {tokens}")
# 예상 토큰: 14

# 커스텀 템플릿 추가
from src.prompts import PromptTemplate

custom = PromptTemplate(
    name="my_template",
    template="요약: {text}",
    description="나만의 템플릿",
    category="custom",
    variables=["text"]
)

library.add_template(custom)
```

---

## 🔍 PromptSelector 클래스

### 기능

대화 특성을 분석하여 최적 프롬프트를 자동 선택

### 선택 전략

1. **길이 기반 선택** - 단어 수에 따라
2. **참여자 수 기반 선택** - 2인/소그룹/대규모
3. **토큰 예산 기반 선택** - 압축 필요 여부
4. **카테고리 기반 선택** - Zero-shot/Few-shot/CoT
5. **적응형 선택** - 종합적 분석

### 주요 메서드

```python
class PromptSelector:
    def select_by_length(dialogue: str) -> PromptTemplate
    def select_by_speakers(dialogue: str) -> PromptTemplate
    def select_by_token_budget(dialogue: str, token_budget: int) -> PromptTemplate
    def select_by_category(category: str, dialogue: str, **kwargs) -> PromptTemplate
    def select_adaptive(dialogue: str, token_budget: int, prefer_category: str) -> PromptTemplate
    def get_selection_info(dialogue: str) -> Dict[str, Any]
```

### 사용 예시

```python
from src.prompts import PromptSelector

selector = PromptSelector()

dialogue = "#Person1#: 안녕하세요 #Person2#: 안녕하세요"

# 1. 길이 기반 선택
template = selector.select_by_length(dialogue)
print(f"길이 기반: {template.name}")
# 길이 기반: short_dialogue

# 2. 참여자 수 기반 선택
template = selector.select_by_speakers(dialogue)
print(f"참여자 수 기반: {template.name}")
# 참여자 수 기반: two_speakers

# 3. 토큰 예산 기반 선택
template = selector.select_by_token_budget(dialogue, token_budget=100)
print(f"토큰 예산 기반: {template.name}")
# 토큰 예산 기반: zero_shot_detailed

# 4. 적응형 선택 (자동 최적화)
template = selector.select_adaptive(
    dialogue=dialogue,
    token_budget=512,
    prefer_category="zero_shot"
)
print(f"적응형: {template.name}")
# 적응형: zero_shot_basic

# 5. 대화 분석 정보
info = selector.get_selection_info(dialogue)
print(f"단어 수: {info['word_count']}")
print(f"참여자 수: {info['num_speakers']}")
print(f"추정 토큰: {info['estimated_tokens']}")
print(f"추천:")
for criterion, template_name in info['recommendations'].items():
    print(f"  {criterion}: {template_name}")
```

---

## 📝 프롬프트 템플릿 종류

### 1. Zero-shot 템플릿 (3개)

예시 없이 직접 요약하는 템플릿

| 템플릿 이름 | 설명 | 사용 시기 |
|-----------|------|---------|
| zero_shot_basic | 기본 템플릿 | 짧은 대화, 빠른 처리 |
| zero_shot_detailed | 상세 템플릿 | 긴 대화, 품질 중시 |
| zero_shot_structured | 구조화 템플릿 | 일관된 형식 필요 |

**예시: zero_shot_basic**
```
다음 대화를 요약해주세요:

{dialogue}

요약:
```

---

### 2. Few-shot 템플릿 (3개)

예시를 제공하여 학습시키는 템플릿

| 템플릿 이름 | 예시 개수 | 사용 시기 |
|-----------|---------|---------|
| few_shot_1shot | 1개 | 단순 패턴 |
| few_shot_2shot | 2개 | 일반적 상황 |
| few_shot_3shot | 3개 | 복잡한 패턴 |

**예시: few_shot_2shot**
```
대화 요약 예시를 참고하여 마지막 대화를 요약해주세요.

예시 1:
대화: {example1_dialogue}
요약: {example1_summary}

예시 2:
대화: {example2_dialogue}
요약: {example2_summary}

이제 다음 대화를 요약해주세요:
대화: {dialogue}
요약:
```

---

### 3. Chain-of-Thought (CoT) 템플릿 (2개)

단계별 사고 과정을 유도하는 템플릿

| 템플릿 이름 | 설명 | 사용 시기 |
|-----------|------|---------|
| cot_step_by_step | 단계별 템플릿 | 복잡한 대화 |
| cot_analytical | 분석적 템플릿 | 긴 대화 (300+ 단어) |

**예시: cot_step_by_step**
```
다음 대화를 단계별로 분석하여 요약해주세요.

단계 1: 대화의 주요 주제 파악
단계 2: 핵심 정보와 결정사항 추출
단계 3: 부수적 정보 제거
단계 4: 간결한 문장으로 정리

대화:
{dialogue}

최종 요약:
```

---

### 4. 대화 길이별 템플릿 (3개)

단어 수에 따라 최적화된 템플릿

| 템플릿 이름 | 길이 범위 | 특징 |
|-----------|---------|------|
| short_dialogue | < 200 단어 | 핵심만 간단히 |
| medium_dialogue | 200-500 단어 | 3-4문장 요약 |
| long_dialogue | > 500 단어 | 주제별 구조화 |

---

### 5. 참여자 수별 템플릿 (3개)

참여자 수에 따라 최적화된 템플릿

| 템플릿 이름 | 참여자 수 | 초점 |
|-----------|---------|------|
| two_speakers | 2명 | 각자의 입장과 합의점 |
| group_small | 3-4명 | 주요 의견과 결론 |
| group_large | 5명 이상 | 핵심 주제와 결정사항 |

---

### 6. 압축 템플릿 (2개)

토큰 절약을 위한 최소화 템플릿

| 템플릿 이름 | 압축률 | 사용 시기 |
|-----------|--------|---------|
| compressed_minimal | 최대 | 토큰 80% 이상 사용 |
| compressed_concise | 높음 | 토큰 60-80% 사용 |

**예시: compressed_minimal**
```
{dialogue}

요약:
```

---

## 💻 사용 방법

### 1. 기본 사용 (자동 선택)

```python
from src.prompts import create_prompt_library, create_prompt_selector

# 초기화
library = create_prompt_library()
selector = create_prompt_selector(library)

# 대화 준비
dialogue = "#Person1#: 안녕하세요. 오늘 회의 시간을 정하려고 합니다. #Person2#: 3시는 어떠세요?"

# 자동 선택 및 포맷팅
template = selector.select_adaptive(dialogue)
prompt = template.format(dialogue=dialogue)

print(f"선택된 템플릿: {template.name}")
print(f"프롬프트:\n{prompt}")
```

---

### 2. 길이 기반 선택

```python
# 짧은 대화
short_dialogue = "A: 안녕 B: 안녕"
template = selector.select_by_length(short_dialogue)
# → short_dialogue 템플릿

# 긴 대화
long_text = " ".join(["대화 내용"] * 300)
template = selector.select_by_length(long_text)
# → long_dialogue 템플릿
```

---

### 3. 토큰 예산 제한

```python
# 토큰 예산 500
template = selector.select_by_token_budget(dialogue, token_budget=500)

# 대화가 400토큰 이상이면 → compressed_minimal
# 대화가 300-400토큰이면 → compressed_concise
# 대화가 300토큰 미만이면 → zero_shot_detailed
```

---

### 4. Few-shot 프롬프트 생성

```python
# Few-shot 예시 준비
example1_dialogue = "A: 점심 뭐 먹을까? B: 김치찌개 어때?"
example1_summary = "점심 메뉴 상의"

example2_dialogue = "A: 내일 회의 시간은? B: 오후 3시"
example2_summary = "회의 시간 결정"

# 2-shot 템플릿 사용
template = library.get_template('few_shot_2shot')
prompt = template.format(
    example1_dialogue=example1_dialogue,
    example1_summary=example1_summary,
    example2_dialogue=example2_dialogue,
    example2_summary=example2_summary,
    dialogue=dialogue
)
```

---

### 5. Solar API와 통합

```python
from src.api import SolarAPI
from src.prompts import create_prompt_selector

# 초기화
api = SolarAPI()
selector = create_prompt_selector()

# 대화 준비
dialogue = "#Person1#: 안녕하세요 #Person2#: 안녕하세요"

# 프롬프트 자동 선택
template = selector.select_adaptive(
    dialogue=dialogue,
    token_budget=512,
    prefer_category="zero_shot"
)

# 프롬프트 생성
prompt = template.format(dialogue=dialogue)

# API 호출
summary = api.summarize(
    dialogue=dialogue,
    custom_prompt=prompt  # 커스텀 프롬프트 사용
)

print(f"요약: {summary}")
```

---

### 6. 대화 분석 및 추천

```python
# 대화 분석
info = selector.get_selection_info(dialogue)

print(f"=== 대화 분석 ===")
print(f"단어 수: {info['word_count']}")
print(f"참여자 수: {info['num_speakers']}")
print(f"추정 토큰: {info['estimated_tokens']}")

print(f"\n=== 추천 템플릿 ===")
for criterion, template_name in info['recommendations'].items():
    print(f"{criterion}: {template_name}")

print(f"\n=== 대화 특성 ===")
for char, value in info['characteristics'].items():
    print(f"{char}: {value}")
```

**출력 예시:**
```
=== 대화 분석 ===
단어 수: 9
참여자 수: 2
추정 토큰: 17

=== 추천 템플릿 ===
by_length: short_dialogue
by_speakers: two_speakers
by_token_budget: zero_shot_detailed

=== 대화 특성 ===
is_short: True
is_long: False
is_two_person: True
is_group: False
```

---

## 🧪 테스트

### 테스트 파일 위치
```
src/tests/test_prompts.py
```

### 테스트 실행

```bash
python src/tests/test_prompts.py
```

### 테스트 항목 (총 9개)

1. ✅ PromptTemplate 클래스
2. ✅ PromptLibrary 초기화
3. ✅ PromptLibrary 기능
4. ✅ 길이 기반 선택
5. ✅ 참여자 수 기반 선택
6. ✅ 토큰 예산 기반 선택
7. ✅ 적응형 선택
8. ✅ 대화 분석 정보
9. ✅ 편의 생성 함수

**결과:** 9/9 테스트 통과 (100%)

---

## 📊 선택 전략 비교

### 길이 임계값

| 단어 수 | 선택 템플릿 | 특징 |
|--------|-----------|------|
| < 200 | short_dialogue | 간단한 지시 |
| 200-500 | medium_dialogue | 표준 지시 |
| > 500 | long_dialogue | 구조화 지시 |

### 토큰 예산 전략

| 대화 토큰/예산 비율 | 선택 템플릿 | 프롬프트 길이 |
|-------------------|-----------|-------------|
| > 80% | compressed_minimal | 최소 |
| 60-80% | compressed_concise | 간결 |
| < 60% | zero_shot_detailed | 상세 |

### 참여자 수 전략

| 참여자 수 | 선택 템플릿 | 초점 |
|---------|-----------|------|
| 2명 | two_speakers | 양자 관계 |
| 3-4명 | group_small | 소그룹 역학 |
| 5명+ | group_large | 주요 결정사항 |

---

## ⚙️ 커스터마이징

### 1. 커스텀 템플릿 추가

```python
from src.prompts import PromptTemplate, PromptLibrary

library = PromptLibrary()

# 커스텀 템플릿 정의
custom_template = PromptTemplate(
    name="business_summary",
    template="""다음은 비즈니스 미팅 대화입니다.

결정사항과 액션 아이템을 중심으로 요약해주세요.

대화:
{dialogue}

결정사항:
액션 아이템:
요약:""",
    description="비즈니스 미팅 전용 템플릿",
    category="domain_specific",
    variables=["dialogue"]
)

# 라이브러리에 추가
library.add_template(custom_template)

# 사용
template = library.get_template('business_summary')
prompt = template.format(dialogue="...")
```

---

### 2. 커스텀 선택 로직

```python
class CustomPromptSelector(PromptSelector):
    """커스텀 선택 로직"""

    def select_by_topic(self, dialogue: str, topic: str) -> PromptTemplate:
        """주제별 템플릿 선택"""

        topic_mapping = {
            '비즈니스': 'business_summary',
            '일상': 'casual_summary',
            '기술': 'technical_summary'
        }

        template_name = topic_mapping.get(topic, 'zero_shot_basic')
        return self.library.get_template(template_name)

# 사용
selector = CustomPromptSelector()
template = selector.select_by_topic(dialogue, topic='비즈니스')
```

---

## ⚠️ 주의사항

### 1. 변수 누락

**문제:** 템플릿 포맷팅 시 필수 변수 누락

```python
template = library.get_template('few_shot_2shot')

# ❌ 에러 발생
prompt = template.format(dialogue="test")  # example 변수 누락

# ✅ 올바른 사용
prompt = template.format(
    example1_dialogue="...",
    example1_summary="...",
    example2_dialogue="...",
    example2_summary="...",
    dialogue="test"
)
```

---

### 2. 토큰 예산 초과

**문제:** 프롬프트 + 대화가 토큰 예산 초과

```python
# 토큰 예산 체크
dialogue_tokens = selector._estimate_tokens(dialogue)
prompt_tokens = library.estimate_tokens(template_name, dialogue=dialogue)
total_tokens = dialogue_tokens + prompt_tokens

if total_tokens > token_budget:
    # 압축 템플릿으로 전환
    template = selector.select_by_token_budget(dialogue, token_budget)
```

---

### 3. Few-shot 예시 선택

**권장 사항:**
- 타겟 대화와 유사한 길이의 예시 사용
- 다양한 패턴 포함 (짧은/긴, 2인/다인)
- 고품질 요약 예시 사용

```python
# ✅ 좋은 예시 선택
example1 = get_example_by_similarity(dialogue, top_k=1)
example2 = get_example_by_diversity(dialogue, examples)

# ❌ 나쁜 예시 선택
example1 = train_data[0]  # 무작위 선택
example2 = train_data[1]  # 다양성 없음
```

---

## 📈 성능 향상 팁

### 1. 템플릿 선택 우선순위

1. **토큰 예산이 제한적인 경우** → token_budget 기반 선택
2. **Few-shot 예시가 있는 경우** → few_shot 템플릿
3. **복잡한 대화인 경우** → CoT 템플릿
4. **기본 경우** → 길이 기반 선택

```python
def smart_select(dialogue, examples=None, token_budget=None):
    if token_budget and is_tight_budget(dialogue, token_budget):
        return selector.select_by_token_budget(dialogue, token_budget)
    elif examples:
        return selector.select_by_category('few_shot', dialogue, num_examples=len(examples))
    elif is_complex(dialogue):
        return selector.select_by_category('cot', dialogue)
    else:
        return selector.select_by_length(dialogue)
```

---

### 2. 프롬프트 압축 전략

```python
# 1. Person 태그 간소화
dialogue = dialogue.replace('#Person1#:', 'A:')
dialogue = dialogue.replace('#Person2#:', 'B:')

# 2. 공백 제거
dialogue = ' '.join(dialogue.split())

# 3. 압축 템플릿 사용
template = selector.select_by_token_budget(dialogue, token_budget)
```

---

### 3. 동적 Few-shot 예시 선택

```python
from sklearn.metrics.pairwise import cosine_similarity
from transformers import AutoTokenizer, AutoModel

def select_few_shot_examples(dialogue, train_data, n_examples=2):
    """유사도 기반 Few-shot 예시 선택"""

    # 임베딩 계산
    target_embedding = get_embedding(dialogue)
    train_embeddings = [get_embedding(ex['dialogue']) for ex in train_data]

    # 유사도 계산
    similarities = cosine_similarity([target_embedding], train_embeddings)[0]

    # Top-k 선택
    top_indices = similarities.argsort()[-n_examples:][::-1]

    return [train_data[i] for i in top_indices]
```

---

## 🔗 관련 파일

**소스 코드:**
- `src/prompts/template.py` - PromptTemplate 및 PromptLibrary
- `src/prompts/selector.py` - PromptSelector
- `src/prompts/__init__.py` - 패키지 초기화

**테스트:**
- `src/tests/test_prompts.py` - 프롬프트 시스템 테스트

**문서:**
- `docs/PRD/15_프롬프트_엔지니어링_전략.md` - PRD 문서
- `docs/모듈화/00_전체_시스템_개요.md` - 시스템 개요

---

## 📚 참고 자료

**프롬프트 엔지니어링 가이드:**
- OpenAI Prompt Engineering Guide
- Anthropic Prompt Design Guide

**Few-shot Learning:**
- Brown et al. (2020) "Language Models are Few-Shot Learners"

**Chain-of-Thought:**
- Wei et al. (2022) "Chain-of-Thought Prompting Elicits Reasoning"

**토큰 최적화:**
- Prompt compression techniques
- Token-efficient prompting strategies
