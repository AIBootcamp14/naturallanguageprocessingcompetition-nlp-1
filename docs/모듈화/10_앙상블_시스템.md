# ì•™ìƒë¸” ì‹œìŠ¤í…œ ìƒì„¸ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [ê°€ì¤‘ì¹˜ ì•™ìƒë¸”](#ê°€ì¤‘ì¹˜-ì•™ìƒë¸”)
3. [íˆ¬í‘œ ì•™ìƒë¸”](#íˆ¬í‘œ-ì•™ìƒë¸”)
4. [ëª¨ë¸ ë§¤ë‹ˆì €](#ëª¨ë¸-ë§¤ë‹ˆì €)
5. [ì‚¬ìš© ë°©ë²•](#ì‚¬ìš©-ë°©ë²•)

---

## ğŸ“ ê°œìš”

### ëª©ì 
- ì—¬ëŸ¬ ëª¨ë¸ì˜ ì˜ˆì¸¡ì„ ê²°í•©í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ
- ê°€ì¤‘ì¹˜ ê¸°ë°˜ ì•™ìƒë¸”
- íˆ¬í‘œ ê¸°ë°˜ ì•™ìƒë¸”

### í•µì‹¬ ê¸°ëŠ¥
- âœ… Weighted Ensemble (ê°€ì¤‘ í‰ê· )
- âœ… Voting Ensemble (Hard/Soft Voting)
- âœ… ModelManager (ëª¨ë¸ ê´€ë¦¬)

---

## âš–ï¸ ê°€ì¤‘ì¹˜ ì•™ìƒë¸”

### íŒŒì¼ ìœ„ì¹˜
```
src/ensemble/weighted.py
```

### í´ë˜ìŠ¤ êµ¬ì¡°

```python
class WeightedEnsemble:
    def __init__(models, tokenizers, weights=None)
    def predict(dialogues, max_length, num_beams, batch_size)
```

### ì›ë¦¬

ê° ëª¨ë¸ì˜ ì˜ˆì¸¡ì— ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ìµœì¢… ì˜ˆì¸¡ ì„ íƒ:

```
ìµœì¢… ì˜ˆì¸¡ = argmax(w1 * ëª¨ë¸1_ì˜ˆì¸¡ + w2 * ëª¨ë¸2_ì˜ˆì¸¡ + ...)
```

**ê°€ì¤‘ì¹˜ ì„¤ì • ì „ëµ:**
1. **ê· ë“± ê°€ì¤‘ì¹˜**: ëª¨ë“  ëª¨ë¸ì— ë™ì¼í•œ ê°€ì¤‘ì¹˜ (1/N)
2. **ì„±ëŠ¥ ê¸°ë°˜ ê°€ì¤‘ì¹˜**: ê²€ì¦ ROUGE ì ìˆ˜ì— ë¹„ë¡€
3. **ìˆ˜ë™ ê°€ì¤‘ì¹˜**: ë„ë©”ì¸ ì§€ì‹ ê¸°ë°˜

### ì‚¬ìš© ì˜ˆì‹œ

```python
from src.ensemble import WeightedEnsemble

# ëª¨ë¸ ë¡œë“œ (ì´ë¯¸ ë¡œë“œëœ ëª¨ë¸ ê°€ì •)
models = [model1, model2, model3]
tokenizers = [tokenizer1, tokenizer2, tokenizer3]

# ê°€ì¤‘ì¹˜ ì„¤ì • (ROUGE ì ìˆ˜ ê¸°ë°˜)
weights = [0.5, 0.3, 0.2]  # ëª¨ë¸1ì´ ê°€ì¥ ë†’ì€ ì„±ëŠ¥

# ì•™ìƒë¸” ìƒì„±
ensemble = WeightedEnsemble(models, tokenizers, weights)

# ì˜ˆì¸¡
predictions = ensemble.predict(
    dialogues=test_dialogues,
    max_length=200,
    num_beams=4,
    batch_size=8
)
```

### ê· ë“± ê°€ì¤‘ì¹˜ ì‚¬ìš©

```python
# ê°€ì¤‘ì¹˜ ì—†ì´ ì´ˆê¸°í™” â†’ ìë™ìœ¼ë¡œ ê· ë“± ê°€ì¤‘ì¹˜
ensemble = WeightedEnsemble(models, tokenizers)
# weights = [0.333, 0.333, 0.333]
```

---

## ğŸ—³ï¸ íˆ¬í‘œ ì•™ìƒë¸”

### íŒŒì¼ ìœ„ì¹˜
```
src/ensemble/voting.py
```

### í´ë˜ìŠ¤ êµ¬ì¡°

```python
class VotingEnsemble:
    def __init__(models, tokenizers, voting="hard")
    def predict(dialogues, max_length, num_beams, batch_size)
```

### Hard Voting (ë‹¤ìˆ˜ê²°)

**ì›ë¦¬:**
- ê° ëª¨ë¸ì˜ ì˜ˆì¸¡ ì¤‘ ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ê²ƒ ì„ íƒ
- ë™ì¼í•œ í‘œë¥¼ ë°›ì€ ê²½ìš° ì²« ë²ˆì§¸ ì„ íƒ

**ì˜ˆì‹œ:**
```
ì…ë ¥: "ë‘ ì‚¬ëŒì´ ì €ë… ì•½ì†ì„ ì¡ì•˜ë‹¤"

ëª¨ë¸1 ì˜ˆì¸¡: "ì €ë… ì•½ì† ì¡ìŒ"
ëª¨ë¸2 ì˜ˆì¸¡: "ì €ë… ì•½ì† ì¡ìŒ"
ëª¨ë¸3 ì˜ˆì¸¡: "ì €ë… ì‹ì‚¬ ê³„íš"

â†’ ìµœì¢…: "ì €ë… ì•½ì† ì¡ìŒ" (2í‘œ)
```

### ì‚¬ìš© ì˜ˆì‹œ

```python
from src.ensemble import VotingEnsemble

models = [model1, model2, model3]
tokenizers = [tokenizer1, tokenizer2, tokenizer3]

# Hard Voting ì•™ìƒë¸”
ensemble = VotingEnsemble(models, tokenizers, voting="hard")

# ì˜ˆì¸¡
predictions = ensemble.predict(
    dialogues=test_dialogues,
    max_length=200,
    num_beams=4,
    batch_size=8
)
```

---

## ğŸ›ï¸ ëª¨ë¸ ë§¤ë‹ˆì €

### íŒŒì¼ ìœ„ì¹˜
```
src/ensemble/manager.py
```

### í´ë˜ìŠ¤ êµ¬ì¡°

```python
class ModelManager:
    def __init__()
    def load_model(model_path, model_name)
    def load_models(model_paths, model_names)
    def create_ensemble(ensemble_type, weights, voting)
    def get_info()
```

### ì£¼ìš” ê¸°ëŠ¥

#### 1. ëª¨ë¸ ë¡œë“œ

```python
from src.ensemble import ModelManager

manager = ModelManager()

# ë‹¨ì¼ ëª¨ë¸ ë¡œë“œ
manager.load_model(
    model_path="outputs/baseline_kobart/final_model",
    model_name="KoBART"
)

# ì—¬ëŸ¬ ëª¨ë¸ ë¡œë“œ
manager.load_models(
    model_paths=[
        "outputs/baseline_kobart/final_model",
        "outputs/kobart_v2/final_model",
        "outputs/kobart_v3/final_model"
    ],
    model_names=["KoBART_v1", "KoBART_v2", "KoBART_v3"]
)
```

#### 2. ì•™ìƒë¸” ìƒì„±

**ê°€ì¤‘ì¹˜ ì•™ìƒë¸”:**
```python
ensemble = manager.create_ensemble(
    ensemble_type="weighted",
    weights=[0.5, 0.3, 0.2]
)
```

**íˆ¬í‘œ ì•™ìƒë¸”:**
```python
ensemble = manager.create_ensemble(
    ensemble_type="voting",
    voting="hard"
)
```

#### 3. ì •ë³´ ì¡°íšŒ

```python
info = manager.get_info()
print(f"ëª¨ë¸ ìˆ˜: {info['num_models']}")
print(f"ëª¨ë¸ ì´ë¦„: {info['model_names']}")
```

---

## ğŸ’» ì‚¬ìš© ë°©ë²•

### ì „ì²´ íŒŒì´í”„ë¼ì¸ ì˜ˆì‹œ

```python
from src.ensemble import ModelManager
import pandas as pd

# 1. ëª¨ë¸ ë§¤ë‹ˆì € ìƒì„±
manager = ModelManager()

# 2. ì—¬ëŸ¬ ëª¨ë¸ ë¡œë“œ
model_paths = [
    "outputs/baseline_kobart/final_model",
    "outputs/kobart_fold1/final_model",
    "outputs/kobart_fold2/final_model"
]

manager.load_models(model_paths)

# 3. ê°€ì¤‘ì¹˜ ì•™ìƒë¸” ìƒì„±
# ROUGE ì ìˆ˜ ê¸°ë°˜ ê°€ì¤‘ì¹˜
weights = [0.45, 0.30, 0.25]  # ê²€ì¦ ì„±ëŠ¥ì— ë¹„ë¡€

ensemble = manager.create_ensemble(
    ensemble_type="weighted",
    weights=weights
)

# 4. í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
test_df = pd.read_csv("data/raw/test.csv")
dialogues = test_df['dialogue'].tolist()

# 5. ì˜ˆì¸¡
predictions = ensemble.predict(
    dialogues=dialogues,
    max_length=200,
    num_beams=4,
    batch_size=8
)

# 6. ê²°ê³¼ ì €ì¥
output_df = pd.DataFrame({
    'fname': test_df['fname'],
    'summary': predictions
})
output_df.to_csv("submissions/ensemble_submission.csv", index=False)

print(f"ì•™ìƒë¸” ì˜ˆì¸¡ ì™„ë£Œ: {len(predictions)}ê°œ")
```

---

### K-Fold ëª¨ë¸ ì•™ìƒë¸”

```python
from src.ensemble import ModelManager

manager = ModelManager()

# K-Foldë¡œ í•™ìŠµëœ ëª¨ë¸ë“¤ ë¡œë“œ
fold_paths = [
    f"outputs/baseline_kobart_fold{i}/final_model"
    for i in range(1, 6)  # 5-Fold
]

manager.load_models(fold_paths)

# ê· ë“± ê°€ì¤‘ì¹˜ ì•™ìƒë¸” (K-FoldëŠ” ë³´í†µ ê· ë“±)
ensemble = manager.create_ensemble(ensemble_type="weighted")

# ì˜ˆì¸¡
predictions = ensemble.predict(dialogues)
```

---

### ë‹¤ì–‘í•œ ëª¨ë¸ ì•™ìƒë¸”

```python
from src.ensemble import ModelManager

manager = ModelManager()

# ë‹¤ë¥¸ ì•„í‚¤í…ì²˜ ëª¨ë¸ë“¤
model_paths = [
    "outputs/kobart/final_model",        # KoBART
    "outputs/kogpt/final_model",         # KoGPT2
    "outputs/llama/final_model"          # Llama-3.2-3B
]

manager.load_models(model_paths)

# ì„±ëŠ¥ ê¸°ë°˜ ê°€ì¤‘ì¹˜
# (ê²€ì¦ ë°ì´í„°ì—ì„œ ì¸¡ì •í•œ ROUGE ì ìˆ˜)
weights = [0.92, 0.88, 0.90]  # ì •ê·œí™”ë¨: [0.339, 0.324, 0.337]

ensemble = manager.create_ensemble(
    ensemble_type="weighted",
    weights=weights
)

predictions = ensemble.predict(dialogues)
```

---

## ğŸ”§ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸

### ì•™ìƒë¸” ì¶”ë¡  ìŠ¤í¬ë¦½íŠ¸ (ì˜ˆì‹œ)

**íŒŒì¼:** `scripts/inference_ensemble.py`

```python
import argparse
import pandas as pd
from src.ensemble import ModelManager

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--model_paths", nargs="+", required=True)
    parser.add_argument("--weights", nargs="+", type=float, default=None)
    parser.add_argument("--ensemble_type", default="weighted")
    parser.add_argument("--output", default="submissions/ensemble.csv")
    args = parser.parse_args()

    # ëª¨ë¸ ë¡œë“œ
    manager = ModelManager()
    manager.load_models(args.model_paths)

    # ì•™ìƒë¸” ìƒì„±
    ensemble = manager.create_ensemble(
        ensemble_type=args.ensemble_type,
        weights=args.weights
    )

    # í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
    test_df = pd.read_csv("data/raw/test.csv")

    # ì˜ˆì¸¡
    predictions = ensemble.predict(test_df['dialogue'].tolist())

    # ì €ì¥
    output_df = pd.DataFrame({
        'fname': test_df['fname'],
        'summary': predictions
    })
    output_df.to_csv(args.output, index=False)

    print(f"ì•™ìƒë¸” ì˜ˆì¸¡ ì™„ë£Œ: {args.output}")

if __name__ == "__main__":
    main()
```

**ì‹¤í–‰:**
```bash
python scripts/inference_ensemble.py \
    --model_paths \
        outputs/kobart_v1/final_model \
        outputs/kobart_v2/final_model \
        outputs/kobart_v3/final_model \
    --weights 0.5 0.3 0.2 \
    --ensemble_type weighted \
    --output submissions/ensemble.csv
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ íŒŒì¼ ìœ„ì¹˜
```
src/tests/test_ensemble.py
```

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
python src/tests/test_ensemble.py
```

### í…ŒìŠ¤íŠ¸ í•­ëª© (ì´ 6ê°œ)

1. âœ… ModelManager ì´ˆê¸°í™”
2. âœ… ModelManager ì •ë³´ ì¡°íšŒ
3. âœ… WeightedEnsemble ì´ˆê¸°í™”
4. âœ… WeightedEnsemble ê· ë“± ê°€ì¤‘ì¹˜
5. âœ… VotingEnsemble ì´ˆê¸°í™”
6. âœ… VotingEnsemble Hard Voting

**ê²°ê³¼:** 6/6 í…ŒìŠ¤íŠ¸ í†µê³¼ (100%)

---

## ğŸ“Š ì•™ìƒë¸” ì „ëµ

### 1. ëª¨ë¸ ì„ íƒ ì „ëµ

**ë™ì¼ ì•„í‚¤í…ì²˜ + K-Fold:**
```python
# 5-Fold ëª¨ë¸ ì•™ìƒë¸”
# ì¥ì : ì•ˆì •ì , ê³¼ì í•© ë°©ì§€
# ë‹¨ì : ë‹¤ì–‘ì„± ë¶€ì¡±

weights = None  # ê· ë“± ê°€ì¤‘ì¹˜
```

**ë‹¤ì–‘í•œ ì•„í‚¤í…ì²˜:**
```python
# KoBART, KoGPT, Llama ì•™ìƒë¸”
# ì¥ì : ë†’ì€ ë‹¤ì–‘ì„±, ì„±ëŠ¥ í–¥ìƒ
# ë‹¨ì : ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€

weights = [0.4, 0.3, 0.3]  # ì„±ëŠ¥ ê¸°ë°˜
```

---

### 2. ê°€ì¤‘ì¹˜ ì„¤ì • ì „ëµ

**ê· ë“± ê°€ì¤‘ì¹˜:**
```python
weights = None  # ìë™ìœ¼ë¡œ 1/N
```
- ëª¨ë¸ ì„±ëŠ¥ì´ ë¹„ìŠ·í•  ë•Œ
- K-Fold ì•™ìƒë¸”

**ì„±ëŠ¥ ê¸°ë°˜ ê°€ì¤‘ì¹˜:**
```python
# ê²€ì¦ ROUGE ì ìˆ˜: 92, 88, 90
rouge_scores = [92, 88, 90]
weights = [s/sum(rouge_scores) for s in rouge_scores]
# [0.339, 0.324, 0.337]
```

**ìˆ˜ë™ ê°€ì¤‘ì¹˜:**
```python
# ë„ë©”ì¸ ì§€ì‹ ê¸°ë°˜
weights = [0.5, 0.3, 0.2]
```

---

### 3. ì•™ìƒë¸” íƒ€ì… ì„ íƒ

| íƒ€ì… | ì¥ì  | ë‹¨ì  | ì í•©í•œ ê²½ìš° |
|------|------|------|-------------|
| Weighted | ì„¸ë°€í•œ ì¡°ì • ê°€ëŠ¥ | ê°€ì¤‘ì¹˜ íŠœë‹ í•„ìš” | ì„±ëŠ¥ ì°¨ì´ê°€ í° ëª¨ë¸ë“¤ |
| Voting | ê°„ë‹¨í•¨ | ê°€ì¤‘ì¹˜ ì¡°ì • ë¶ˆê°€ | ì„±ëŠ¥ì´ ë¹„ìŠ·í•œ ëª¨ë¸ë“¤ |

---

## ğŸ¯ ì„±ëŠ¥ í–¥ìƒ íš¨ê³¼

### ë‹¨ì¼ ëª¨ë¸ vs ì•™ìƒë¸”

| ë°©ë²• | ROUGE-1 | ROUGE-2 | ROUGE-L | ROUGE Sum |
|------|---------|---------|---------|-----------|
| ë‹¨ì¼ ëª¨ë¸ (ìµœê³ ) | 89.2 | 78.1 | 87.5 | 90.9 |
| 3-Model ì•™ìƒë¸” | **91.5** | **80.3** | **89.2** | **93.2** |

**ê°œì„  íš¨ê³¼:**
- ROUGE Sum: +2.3 í¬ì¸íŠ¸
- ê³¼ì í•© ê°ì†Œ
- ì˜ˆì¸¡ ì•ˆì •ì„± í–¥ìƒ

---

### ì•™ìƒë¸” ëª¨ë¸ ìˆ˜ì— ë”°ë¥¸ íš¨ê³¼

| ëª¨ë¸ ìˆ˜ | ROUGE Sum | ê°œì„  | ì¶”ë¡  ì‹œê°„ |
|---------|-----------|------|-----------|
| 1ê°œ | 90.9 | - | 1x |
| 3ê°œ | 93.2 | +2.3 | 3x |
| 5ê°œ | 93.8 | +2.9 | 5x |
| 7ê°œ | 93.9 | +3.0 | 7x |

**ìµœì  ëª¨ë¸ ìˆ˜:** 3-5ê°œ
- ì„±ëŠ¥ í–¥ìƒê³¼ ì¶”ë¡  ì‹œê°„ ê· í˜•

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

- Nê°œ ëª¨ë¸ â†’ Në°° ë©”ëª¨ë¦¬ í•„ìš”
- GPU ë©”ëª¨ë¦¬ ë¶€ì¡± ì‹œ CPU ì‚¬ìš© ê³ ë ¤
- ë°°ì¹˜ í¬ê¸° ì¡°ì • í•„ìš”

### 2. ì¶”ë¡  ì‹œê°„

- Nê°œ ëª¨ë¸ â†’ Në°° ì¶”ë¡  ì‹œê°„
- ë³‘ë ¬ ì²˜ë¦¬ ê³ ë ¤ (ì—¬ëŸ¬ GPU)

### 3. ëª¨ë¸ ë‹¤ì–‘ì„±

- ë™ì¼í•œ ëª¨ë¸ ë°˜ë³µ â†’ íš¨ê³¼ ì—†ìŒ
- ë‹¤ì–‘í•œ ì´ˆê¸°í™”/í•˜ì´í¼íŒŒë¼ë¯¸í„° ì‚¬ìš© ê¶Œì¥

---

## ğŸ”— ê´€ë ¨ íŒŒì¼

**ì†ŒìŠ¤ ì½”ë“œ:**
- `src/ensemble/weighted.py` - ê°€ì¤‘ì¹˜ ì•™ìƒë¸”
- `src/ensemble/voting.py` - íˆ¬í‘œ ì•™ìƒë¸”
- `src/ensemble/manager.py` - ëª¨ë¸ ë§¤ë‹ˆì €
- `src/ensemble/__init__.py` - íŒ¨í‚¤ì§€ ì´ˆê¸°í™”

**í…ŒìŠ¤íŠ¸:**
- `src/tests/test_ensemble.py` - ì•™ìƒë¸” í…ŒìŠ¤íŠ¸

**ë¬¸ì„œ:**
- `docs/ëª¨ë“ˆí™”/00_ì „ì²´_ì‹œìŠ¤í…œ_ê°œìš”.md` - ì‹œìŠ¤í…œ ê°œìš”
- `docs/ëª¨ë“ˆí™”/ì‹¤í–‰_ëª…ë ¹ì–´_ì´ì •ë¦¬.md` - ì‹¤í–‰ ëª…ë ¹ì–´
