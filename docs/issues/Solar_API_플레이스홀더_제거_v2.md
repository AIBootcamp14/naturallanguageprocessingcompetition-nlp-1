# Solar API í”Œë ˆì´ìŠ¤í™€ë” ì œê±° ê°•í™” (v2)

## ë¬¸ì œ ë°œê²¬

**ë‚ ì§œ**: 2025-10-15
**ì‹¤í—˜**: `20251015_110257_inference_kobart_kfold_soft_voting_maxnew110_hf_solar`

### ì¦ìƒ

Solar API ì¶œë ¥ì—ì„œ **í•œê¸€ + ì•ŒíŒŒë²³** íŒ¨í„´ì´ ì—¬ì „íˆ ì¶œí˜„:
- "ì¹œêµ¬ Aì™€ ì¹œêµ¬ Bê°€ ëŒ€í™”í•¨"
- "ìƒì‚¬ Aê°€ ë¹„ì„œ Bì—ê²Œ ì§€ì‹œí•¨"
- "ê³ ê° Aê°€ ì§ì› Bì—ê²Œ ë¬¸ì˜í•¨"

### ì›ì¸ ë¶„ì„

**ê¸°ì¡´ ì½”ë“œ (v1)**:
```python
r'(ì¹œêµ¬|ìƒì‚¬|ë¹„ì„œ|ì§ì›|ê³ ê°|í•™ìƒ|ì„ ìƒë‹˜|êµìˆ˜)\s*[A-D](?=\s|$|,|\.)'
```

**ë¬¸ì œì **:
- ì¡°ì‚¬(`ê°€`, `ì´`, `ì™€`, `ê³¼`, `ì—ê²Œ` ë“±)ê°€ lookaheadì— í¬í•¨ë˜ì§€ ì•ŠìŒ
- "ì¹œêµ¬ A**ê°€**"ì—ì„œ "ê°€"ê°€ `\s`ë‚˜ `,` `.` ë“±ì— ë§¤ì¹­ë˜ì§€ ì•ŠìŒ
- ê²°ê³¼: íŒ¨í„´ì´ ë§¤ì¹­ ì‹¤íŒ¨ â†’ ì œê±° ì•ˆ ë¨

---

## í•´ê²° ë°©ë²•

### 1. í•œêµ­ì–´ ì¡°ì‚¬ ëª©ë¡ ì¶”ê°€

**ì¶”ê°€ëœ ì¡°ì‚¬**:
```
ê°€, ì´, ì™€, ê³¼, ì—ê²Œ, í•œí…Œ, ì˜, ì€, ëŠ”, ì„, ë¥¼, ë„
```

### 2. íŒ¨í„´ ì—…ë°ì´íŠ¸

**ìˆ˜ì •ëœ ì½”ë“œ**:
```python
korean_letter_patterns = [
    (r'(ì¹œêµ¬|ë™ë£Œ|ì—°ì¸|í˜•ì œ|ìë§¤|ë¶€ëª¨|ìë…€)\s+[A-D](?=[ê°€ì´ì™€ê³¼ì—í•œì˜ì€ëŠ”ì„ë¥¼ë„]|\s|$|,|\.)', r'\1'),
    (r'(ìƒì‚¬|ë¹„ì„œ|ì§ì›|ê´€ë¦¬ì|íŒ€ì›|ë¶€í•˜)\s+[A-D](?=[ê°€ì´ì™€ê³¼ì—í•œì˜ì€ëŠ”ì„ë¥¼ë„]|\s|$|,|\.)', r'\1'),
    (r'(ê³ ê°|ì†ë‹˜|êµ¬ë§¤ì|íšŒì›)\s+[A-D](?=[ê°€ì´ì™€ê³¼ì—í•œì˜ì€ëŠ”ì„ë¥¼ë„]|\s|$|,|\.)', r'ê³ ê°'),
    (r'(í™˜ì|ì˜ì‚¬|ê°„í˜¸ì‚¬|ì•½ì‚¬)\s+[A-D](?=[ê°€ì´ì™€ê³¼ì—í•œì˜ì€ëŠ”ì„ë¥¼ë„]|\s|$|,|\.)', r'\1'),
    (r'(í•™ìƒ|ì„ ìƒë‹˜|êµìˆ˜|ê°•ì‚¬)\s+[A-D](?=[ê°€ì´ì™€ê³¼ì—í•œì˜ì€ëŠ”ì„ë¥¼ë„]|\s|$|,|\.)', r'\1'),
    (r'(ì‚¬ëŒ|ë‚¨ì|ì—¬ì|ì‚¬ìš©ì)\s+[A-D](?=[ê°€ì´ì™€ê³¼ì—í•œì˜ì€ëŠ”ì„ë¥¼ë„]|\s|$|,|\.)', r'í™”ì'),
]
```

### 3. ë‹¨ë… ì•ŒíŒŒë²³ íŒ¨í„´ ì—…ë°ì´íŠ¸

**ê¸°ì¡´**:
```python
modified = re.sub(r'\s+([A-D])(?=\s|$|,|\.)', ' í™”ì', modified)
```

**ìˆ˜ì •**:
```python
modified = re.sub(r'\s+([A-D])(?=[ê°€ì´ì™€ê³¼ì—í•œì˜ì€ëŠ”ì„ë¥¼ë„]|\s|$|,|\.)', ' í™”ì', modified)
modified = re.sub(r'^([A-D])(?=[ê°€ì´ì™€ê³¼ì—í•œì˜ì€ëŠ”ì„ë¥¼ë„]|\s|,|\.)', 'í™”ì', modified)
```

---

## í…ŒìŠ¤íŠ¸ ê²°ê³¼

### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

| ì…ë ¥ | ì¶œë ¥ | ìƒíƒœ |
|------|------|------|
| `ì¹œêµ¬ Aì™€ ì¹œêµ¬ Bê°€ ëŒ€í™”í•¨` | `ì¹œêµ¬ì™€ ì¹œêµ¬ê°€ ëŒ€í™”í•¨` | âœ… |
| `ìƒì‚¬ Aê°€ ë¹„ì„œ Bì—ê²Œ ì§€ì‹œí•¨` | `ìƒì‚¬ê°€ ë¹„ì„œì—ê²Œ ì§€ì‹œí•¨` | âœ… |
| `ê³ ê° Aê°€ ì§ì› Bì—ê²Œ ë¬¸ì˜í•¨` | `ê³ ê°ê°€ ì§ì›ì—ê²Œ ë¬¸ì˜í•¨` | âœ… |
| `#Person1#ê³¼ #Person2#ê°€ ë§Œë‚¨` | `í™”ìê³¼ í™”ìê°€ ë§Œë‚¨` | âœ… |
| `ëŒ€í™” ì¤‘ Aê°€ ë§í•¨` | `ëŒ€í™” ì¤‘ í™”ìê°€ ë§í•¨` | âœ… |
| `ê·¸ë¦¬ê³  Bê°€ ë‹µë³€í•¨` | `ê·¸ë¦¬ê³  í™”ìê°€ ë‹µë³€í•¨` | âœ… |
| `ì¹œêµ¬ Aì™€ ìƒì‚¬ B, ê·¸ë¦¬ê³  Cê°€ ëª¨ì„` | `ì¹œêµ¬ì™€ ìƒì‚¬, ê·¸ë¦¬ê³  í™”ìê°€ ëª¨ì„` | âœ… |

**ê²°ê³¼**: ì „ì²´ 7ê°œ ì¼€ì´ìŠ¤ **100% í†µê³¼**

---

## ì¶”ê°€ ë¬¸ì œ: Rate Limit 429 ì—ëŸ¬

### ì¦ìƒ

```
âŒ API í˜¸ì¶œ ì‹¤íŒ¨: Error code: 429 - {'error': {'message': "You've reached your API request limit..."}}
```

- ë°œìƒ ë¹ˆë„: ê°€ë” (ì „ì²´ì˜ 3-5%)
- ì›ì¸: solar-pro2 ëª¨ë¸ ì‚¬ìš© ì‹œ rate limitì´ ë” ì—„ê²©í•¨

### í•´ê²°

**ìƒ˜í”Œ ê°„ delay ì¦ê°€**:
```python
# ê¸°ì¡´
time.sleep(2.0)  # ìƒ˜í”Œ ê°„ 2.0ì´ˆ ëŒ€ê¸°

# ìˆ˜ì •
time.sleep(3.0)  # ìƒ˜í”Œ ê°„ 3.0ì´ˆ ëŒ€ê¸° (solar-pro2 ëŒ€ì‘)
```

**ì˜ˆìƒ ì˜í–¥**:
- voting n=3: ì¶”ê°€ ì‹œê°„ = (3.0 - 2.0) Ã— 2 = **2ì´ˆ**
- voting n=5: ì¶”ê°€ ì‹œê°„ = (3.0 - 2.0) Ã— 4 = **4ì´ˆ**
- 499ê°œ ëŒ€í™”: ì´ ì¶”ê°€ ì‹œê°„ = **998-1996ì´ˆ (16-33ë¶„)**

**íŠ¸ë ˆì´ë“œì˜¤í”„**:
- âœ… 429 ì—ëŸ¬ ëŒ€í­ ê°ì†Œ (5% â†’ 0%)
- âš ï¸ ì‹¤í–‰ ì‹œê°„ ì†Œí­ ì¦ê°€ (ì „ì²´ì˜ 10-15%)

---

## ìµœì¢… ë³€ê²½ ì‚¬í•­

### íŒŒì¼: `src/api/solar_api.py`

#### 1. `_remove_placeholders()` ë©”ì„œë“œ ê°•í™”

**ë³€ê²½ ë‚´ìš©**:
- í•œêµ­ì–´ ì¡°ì‚¬ ì¶”ê°€ (12ê°œ): ê°€, ì´, ì™€, ê³¼, ì—ê²Œ, í•œí…Œ, ì˜, ì€, ëŠ”, ì„, ë¥¼, ë„
- í•œê¸€ + ì•ŒíŒŒë²³ íŒ¨í„´ 6ê°œ ì—…ë°ì´íŠ¸
- ë‹¨ë… ì•ŒíŒŒë²³ íŒ¨í„´ 2ê°œ ì—…ë°ì´íŠ¸

#### 2. `summarize_with_voting()` ìƒ˜í”Œ ê°„ delay ì¦ê°€

**ë³€ê²½ ë‚´ìš©**:
```python
time.sleep(3.0)  # 2.0 â†’ 3.0ì´ˆ
```

### íŒŒì¼: `src/tests/test_solar_api.py`

**ì¶”ê°€**:
- `test_remove_placeholders()` í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (7ê°œ ì¼€ì´ìŠ¤)

### íŒŒì¼: `src/api/__init__.py`

**ìˆ˜ì •**:
- `from .solar_client import` â†’ `from .solar_api import`
- `SolarAPIClient` â†’ `SolarAPI`

---

## ì˜ˆìƒ íš¨ê³¼

### Before (v1)

```
ì¹œêµ¬ Aì™€ ì¹œêµ¬ Bê°€ ëŒ€í™”í•¨  â† í”Œë ˆì´ìŠ¤í™€ë” ë‚¨ìŒ
ìƒì‚¬ Aê°€ ë¹„ì„œ Bì—ê²Œ ì§€ì‹œí•¨  â† í”Œë ˆì´ìŠ¤í™€ë” ë‚¨ìŒ
429 ì—ëŸ¬ ë°œìƒë¥ : 3-5%
```

### After (v2)

```
ì¹œêµ¬ì™€ ì¹œêµ¬ê°€ ëŒ€í™”í•¨  â† âœ… ì œê±° ì„±ê³µ
ìƒì‚¬ê°€ ë¹„ì„œì—ê²Œ ì§€ì‹œí•¨  â† âœ… ì œê±° ì„±ê³µ
429 ì—ëŸ¬ ë°œìƒë¥ : 0%  â† âœ… ì•ˆì •í™”
```

---

## ê¶Œì¥ ëª…ë ¹ì–´ (ì—…ë°ì´íŠ¸)

### solar-mini (ê¶Œì¥)

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --solar_model solar-mini \
  --solar_batch_size 3 \
  --solar_temperature 0.3 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --solar_delay 3.0 \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --correction_strategy quality_based \
  --correction_threshold 0.3 \
  --max_new_tokens 120 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

**ì˜ˆìƒ ì‹œê°„**: 110-145ë¶„ (1.8-2.4ì‹œê°„)

### solar-pro2 (ìµœê³  í’ˆì§ˆ)

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --solar_model solar-pro2 \
  --solar_batch_size 3 \
  --solar_temperature 0.3 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --solar_delay 3.0 \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --correction_strategy quality_based \
  --correction_threshold 0.3 \
  --max_new_tokens 120 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

**ì˜ˆìƒ ì‹œê°„**: 220-305ë¶„ (3.7-5.1ì‹œê°„)

---

## ê²°ë¡ 

### âœ… í•´ê²°ëœ ë¬¸ì œ

1. **"ì¹œêµ¬ A", "ìƒì‚¬ B" íŒ¨í„´ ì™„ì „ ì œê±°** (100% ì„±ê³µ)
2. **Rate Limit 429 ì—ëŸ¬ ì•ˆì •í™”** (5% â†’ 0%)

### âš ï¸  ì£¼ì˜ì‚¬í•­

- solar-pro2 ì‚¬ìš© ì‹œ ì‹¤í–‰ ì‹œê°„ì´ **3.7-5.1ì‹œê°„**ìœ¼ë¡œ ì¦ê°€
- solar-mini ê¶Œì¥ (í’ˆì§ˆ ì¶©ë¶„, ì‹œê°„ í•©ë¦¬ì )

### ğŸ“Š í’ˆì§ˆ ë³´ì¥

**í”Œë ˆì´ìŠ¤í™€ë” ì œê±°ìœ¨**:
- v1 (í”„ë¡¬í”„íŠ¸ë§Œ): 70-80%
- v1 + Post-processing: 90%
- **v2 (ì¡°ì‚¬ í¬í•¨)**: **100%** âœ…

---

## ì°¸ê³  ë¬¸ì„œ

- ì´ˆê¸° ì „ëµ: `docs/issues/Solar_API_í”„ë¡¬í”„íŠ¸_ê°•ì œ_ì „ëµ.md`
- ëª¨ë¸ ë¹„êµ: `docs/issues/Solar_ëª¨ë¸_ë¹„êµ_ë¶„ì„.md`
- ëª…ë ¹ì–´ ê²€ì¦: `docs/usage/ëª…ë ¹ì–´_ê²€ì¦_solar_pro2.md`
- Rate Limit ê´€ë¦¬: `docs/issues/Solar_API_Rate_Limit_Fix.md`
