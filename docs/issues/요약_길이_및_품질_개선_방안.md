# 요약 길이 및 품질 개선 방안

**작성일**: 2025-10-15
**실험**: 20251015_052247_inference_kobart_kfold_soft_voting_bs32_maxnew80_hf_solar
**우선순위**: 🔴 Critical

---

## 1. 현황 분석

### 1.1 실험 결과

**실행 시간**:
- K-Fold 앙상블: 4분 25초 (05:22:47 ~ 05:27:12)
- HuggingFace 보정: 1분 45초 (05:27:12 ~ 05:28:57)
- Solar API: **10분 34초** (05:28:57 ~ 05:39:31)
- **전체 소요 시간**: **16분 44초**

**결과 통계**:
- 전체 샘플: 499개
- 평균 요약 길이: **52.1자** ⚠️  (너무 짧음!)

### 1.2 test_28 사례 분석

#### 원본 대화 (580자)
```
#Person1#: 바보 같은 여자애 때문에 돈이 이렇게 많이 필요할 줄이야. 이제 ATM에서 돈을 찾아야겠네...
#Person2#: 안녕하세요, 유니버설 은행입니다. 카드를 슬롯에 넣어 주세요.
#Person1#: 카드 넣는 것 정도는 알아, 이 멍청한 기계가 나를 바보로 만드네...
#Person2#: 6자리 비밀번호를 입력하고 우물 정자를 눌러 주세요. 감사합니다. 옵션을 선택해 주세요.
#Person1#: 빨리 처리해, 돈 좀 주라고!
#Person2#: 인출할 금액을 입력해 주세요. 감사합니다. 세계 야생동물 재단으로 10000달러를 이체하고 싶으시면 1번을 눌러 주세요.
#Person1#: 아니, 아니! 이건 아니야! 멍청한 기계, 무슨 짓이야! 그러지 마!
#Person2#: 확인되었습니다. 저희 은행을 이용해 주셔서 감사합니다! 카드를 제거해 주세요. 안녕히 가세요!
#Person1#: 아니, 이게 뭐야! 내 돈 돌려줘!
#Person2#: 위험, 위험! 출입구가 봉쇄되었으며 지역 당국이 도착할 때까지 문이 잠긴 상태로 유지됩니다. 저희 은행을 이용해 주셔서 감사합니다. 좋은 하루 보내세요.
```

#### 현재 요약 (30자)
```
고객이 ATM 기계 오작동으로 인해 은행 직원과 대화하며 돈 인출 문제를 겪음.
```

**❌ 문제점**:
1. **화자 오판**: Person2는 ATM 자동응답이지 "은행 직원" 아님
2. **핵심 스토리 누락**:
   - 실수로 야생동물재단에 1만 달러 송금
   - 취소 불가
   - 보안 절차로 출입구 봉쇄
3. **너무 짧음**: 30자로는 핵심 내용 전달 불가

#### 올바른 요약 예시 (사용자 제공, 약 120자)
```
한 고객이 ATM을 사용하다가 실수로 세계 야생동물 재단에 1만 달러를 송금하게 된다.
고객은 당황하며 취소를 시도하지만, ATM은 자동 처리 후 "감사합니다"라는 응답만 반복한다.
이어 보안 절차가 발동되어 출입구가 봉쇄되고, 지역 당국이 도착할 때까지 문이 잠긴 상태로 유지된다는 경고가 나온다.
결국 고객은 돈을 잃고 기계에 갇힌 채 분노한다.
```

### 1.3 기타 문제점

**여전히 발견되는 플레이스홀더**:
- `test_2`: "친구 A가 친구 B에게..."
- `test_3`: "친구들이... A가 Brian과..."
- `test_5`: "A는 회사를 그만두고... B는..."

---

## 2. 근본 원인 분석

### 2.1 요약 길이 문제

**현재 파라미터**:
```bash
--max_new_tokens 80       # 최대 80토큰
--min_new_tokens 20       # 최소 20토큰
--length_penalty 0.8      # 짧은 요약 선호
```

**문제**:
- `max_new_tokens=80`은 약 50-60자 수준
- `length_penalty=0.8`은 짧은 요약을 더 선호
- 평균 52.1자 → 핵심 내용 누락 필연적

**근본 원인**:
- 사용자 요구: "원본보다 짧게, 1-2문장"
- 하지만 **복잡한 스토리(test_28 같은)는 1-2문장으로 불가능**
- **적응형 길이 조절** 필요

### 2.2 화자 역할/성격 파악 미흡

**현재 프롬프트 v2.0 한계**:
1. **비인간 대화자 감지 부족**:
   - ATM 자동응답을 "직원"으로 오판
   - "안녕하세요, 유니버설 은행입니다" → 사람으로 착각

2. **역할 구조 분석 표면적**:
   - 말투(존댓말) 분석만으로 "고객/직원" 판단
   - **실제 역할**(ATM 기계 vs 사람) 구분 못함

3. **성격/감정 중심 분석 부족**:
   - Person1의 분노("멍청한 기계", "내 돈 돌려줘") 무시
   - Person2의 기계적 반복("감사합니다", "좋은 하루 보내세요") 무시

### 2.3 Solar API 단일 실행 문제

**현재 구조**:
```
KoBART (5-Fold) → HF Correction → Solar API (1회) → 최종 요약
```

**문제**:
- Solar API가 1회만 실행
- KoBART가 이미 "친구 A/B"로 출력하면 Solar가 수정 못함
- **품질 검증 없음**

**사용자 요구**:
- K-Fold처럼 Solar를 여러 번 실행
- 가장 핵심적인 내용을 잘 파악한 요약 선택
- 화자 호칭/명칭을 정확히 캐치한 결과 우선

---

## 3. 해결 방안

### 3.1 요약 길이 최적화

#### 방안 1: 적응형 길이 조절

**기본 원칙**:
- 단순 대화 (일상, 인사, 짧은 요청): 50-80자
- 중간 복잡도 (조언, 계획): 80-120자
- 복잡한 스토리 (test_28처럼 사건 전개): 120-180자

**구현**:
```python
def adaptive_length_params(dialogue_length, dialogue_complexity):
    """대화 길이와 복잡도에 따라 파라미터 조절"""
    if dialogue_complexity == "high":  # test_28 같은 경우
        return {
            "max_new_tokens": 150,
            "min_new_tokens": 80,
            "length_penalty": 0.9
        }
    elif dialogue_complexity == "medium":
        return {
            "max_new_tokens": 100,
            "min_new_tokens": 50,
            "length_penalty": 0.85
        }
    else:  # simple
        return {
            "max_new_tokens": 80,
            "min_new_tokens": 30,
            "length_penalty": 0.8
        }
```

**복잡도 판단 기준**:
- 대화 턴 수: 10턴 이상 = high
- 감정 변화: 분노, 당황, 놀람 포함 = high
- 사건 전개: 문제 발생 → 실패 → 결과 = high

#### 방안 2: 현재 파라미터 즉시 조정

**추천 파라미터** (일괄 적용):
```bash
--max_new_tokens 120         # 80 → 120 (50% 증가)
--min_new_tokens 40          # 20 → 40 (100% 증가)
--length_penalty 0.9         # 0.8 → 0.9 (길이 패널티 완화)
--num_beams 6                # 유지
--repetition_penalty 1.3     # 1.5 → 1.3 (자연스러운 반복 허용)
```

**예상 효과**:
- 평균 요약 길이: 52.1자 → **80-100자**
- test_28 같은 복잡한 케이스: 120자 이상 허용

### 3.2 프롬프트 강화 (v3.0)

#### 추가 사항 1: 비인간 대화자 감지

```
STEP 0: 대화자 유형 판별 (최우선!)

0-1. 비인간 대화자 감지:
   * 자동 시스템/기계: "카드를 슬롯에 넣어 주세요", "옵션을 선택해 주세요",
                      반복적인 안내 멘트, "감사합니다" 자동 응답
     → ATM, 음성 안내 시스템, 챗봇, 자판기

   * 인간 대화자: 자연스러운 반응, 감정 표현, 질문에 대한 이해와 응답

0-2. 특수 상황:
   * ATM 대화: Person1 = 사용자/고객, Person2 = ATM 기계 (절대 "직원" 아님!)
   * 음성 안내: "1번을 누르세요", "다음 옵션을 선택하세요" → 자동 시스템
   * 챗봇: 정형화된 응답, 메뉴 형식 대화

명칭 지정:
- ATM 기계 → "ATM" or "자동 시스템"
- 사용자 → "고객" or 구체적 상황 명시 (실수한 고객, 당황한 고객)
```

#### 추가 사항 2: 감정/성격 중심 분석

```
STEP 1-4. 화자 감정 및 성격 파악:

감정 표현 분석:
- 분노: "멍청한", "뭐야!", "돌려줘"
  → "분노한 고객", "당황한 사용자"

- 당황/혼란: "아니, 아니!", "이건 아니야!", "무슨 짓이야"
  → "당황한 고객", "혼란스러운 사용자"

- 무감정/기계적: "감사합니다", "좋은 하루 보내세요" (반복)
  → "ATM 자동 응답", "시스템 메시지"

성격 반영:
- 적극적/주도적: 질문하고 지시하는 쪽 → "요청자", "질문자"
- 수동적/대응적: 답변하고 수행하는 쪽 → "응답자", "안내자"
```

#### 추가 사항 3: 스토리 구조 파악

```
STEP 5: 대화 스토리 구조 파악 (복잡한 대화용)

5-1. 사건 전개 확인:
   - 시작 상황: 무엇을 하려고 했는가?
   - 문제 발생: 무엇이 잘못되었는가?
   - 시도/반응: 어떻게 대응했는가?
   - 결과: 최종 결과는?

5-2. 핵심 사건 추출:
   - test_28 예시:
     * 시작: ATM에서 돈 인출 시도
     * 문제: 실수로 야생동물재단에 1만 달러 송금
     * 시도: 취소 요청 ("그러지 마!", "내 돈 돌려줘")
     * 결과: 취소 불가 + 보안 봉쇄

   올바른 요약: 4가지 사건 모두 포함해야 함!
```

#### 금지 사항 강화

```
7. **금지 사항** (절대 준수):
   - ❌❌❌ A/B/C/D, #Person1#/#Person2# 플레이스홀더 사용 금지!
   - ❌ "친구 A", "친구 B" 같은 혼합 명칭 금지!
   - ❌ ATM/자동 시스템을 "직원"이나 사람으로 표현 금지!
   - ❌ 복잡한 스토리를 1문장으로 축약 금지! (핵심 사건 모두 포함)
   - ❌ 감정/성격 무시 금지 ("당황한", "분노한" 등 명시)
```

### 3.3 Solar API 다중 실행 시스템

#### 구조 설계

```
KoBART (5-Fold) → HF Correction → Solar API (N회 실행) → 품질 평가 → 최고 품질 선택
```

#### 구현 방안

**Option 1: Self-Consistency (N회 샘플링)**

```python
def solar_multi_sample(dialogue, n_samples=3, temperature=0.7):
    """Solar API를 N번 실행하여 다양한 요약 생성"""
    summaries = []

    for i in range(n_samples):
        summary = solar_api.summarize(
            dialogue,
            temperature=0.2 + (i * 0.2),  # 0.2, 0.4, 0.6 다양성
            top_p=0.3 + (i * 0.1)         # 0.3, 0.4, 0.5
        )
        summaries.append(summary)

    # 품질 평가 및 선택
    best_summary = select_best_summary(summaries, dialogue)
    return best_summary
```

**Option 2: Iterative Refinement (반복 개선)**

```python
def solar_iterative_refinement(dialogue, n_iterations=2):
    """Solar API를 반복 실행하여 점진적 개선"""
    summary = kobart_output  # 초기 요약

    for i in range(n_iterations):
        # 피드백 생성
        feedback = check_summary_quality(summary, dialogue)

        # 개선 요청
        if feedback["has_issues"]:
            prompt = f"""
            이전 요약: {summary}
            문제점: {feedback["issues"]}

            문제점을 수정하여 다시 요약하세요.
            """
            summary = solar_api.summarize(dialogue, custom_prompt=prompt)

    return summary
```

#### 품질 평가 기준

```python
def evaluate_summary_quality(summary, dialogue):
    """요약 품질 평가"""
    score = 0
    issues = []

    # 1. 플레이스홀더 검사 (자동)
    if re.search(r'[A-D]\b|#Person\d+#|친구 [A-D]|고객 [A-D]', summary):
        score -= 50
        issues.append("플레이스홀더 사용")

    # 2. 화자 명칭 적절성 (휴리스틱)
    if is_atm_dialogue(dialogue) and "직원" in summary:
        score -= 30
        issues.append("ATM을 직원으로 오판")

    # 3. 길이 적절성
    if len(summary) < 50:
        score -= 20
        issues.append("너무 짧음")
    elif len(summary) > len(dialogue):
        score -= 30
        issues.append("원본보다 김")

    # 4. 핵심 키워드 포함 여부
    key_events = extract_key_events(dialogue)
    included_events = sum(1 for event in key_events if event in summary)
    score += included_events * 20

    # 5. 감정 반영 여부
    emotions = detect_emotions(dialogue)
    if emotions and not any(e in summary for e in ["당황", "분노", "혼란"]):
        score -= 10
        issues.append("감정 미반영")

    return {"score": score, "issues": issues}
```

#### 최고 품질 선택

```python
def select_best_summary(summaries, dialogue):
    """N개 요약 중 최고 품질 선택"""
    evaluated = []

    for summary in summaries:
        quality = evaluate_summary_quality(summary, dialogue)
        evaluated.append({
            "summary": summary,
            "score": quality["score"],
            "issues": quality["issues"]
        })

    # 점수 내림차순 정렬
    evaluated.sort(key=lambda x: x["score"], reverse=True)

    # 최고 점수 선택
    best = evaluated[0]
    logger.info(f"선택된 요약 (점수: {best['score']}): {best['summary']}")

    return best["summary"]
```

---

## 4. 구현 계획

### Phase 1: 즉시 적용 (긴급)

1. **추론 파라미터 조정**:
   ```bash
   --max_new_tokens 120
   --min_new_tokens 40
   --length_penalty 0.9
   --repetition_penalty 1.3
   ```

2. **프롬프트 v3.0 적용**:
   - STEP 0: 비인간 대화자 감지 추가
   - STEP 1-4: 감정/성격 분석 추가
   - STEP 5: 스토리 구조 파악 추가
   - 금지 사항 강화

### Phase 2: Solar API 다중 실행 (중기)

1. **Self-Consistency 구현**:
   - N=3으로 시작 (시간 절충)
   - temperature 다양화 (0.2, 0.4, 0.6)

2. **품질 평가 시스템 구축**:
   - 자동 평가 함수 구현
   - 플레이스홀더/화자 오판/길이 검증

3. **최고 품질 선택 로직**:
   - 점수 기반 선택
   - 로깅 강화

### Phase 3: 적응형 시스템 (장기)

1. **복잡도 자동 판별**:
   - 대화 턴 수, 감정 변화, 사건 전개 분석
   - 복잡도에 따라 파라미터 자동 조절

2. **Iterative Refinement**:
   - 피드백 기반 반복 개선
   - 문제점 자동 감지 및 재요약

---

## 5. 예상 효과

### Phase 1 적용 후

**요약 길이**:
- 현재 평균: 52.1자
- 예상 평균: **80-100자**

**test_28 예상 결과**:
```
한 고객이 ATM 사용 중 실수로 세계 야생동물 재단에 1만 달러를 송금하게 되어 당황한다.
취소를 시도하지만 ATM은 "감사합니다"라는 자동 응답만 반복하며, 보안 절차가 발동되어 출입구가 봉쇄되고 고객은 기계에 갇힌 채 분노한다.
```
(약 110자 - 핵심 사건 4개 모두 포함)

**플레이스홀더 감소**:
- 현재: test_2, 3, 5 등에서 발견
- 예상: 80% 이상 제거

### Phase 2 적용 후

**품질 향상**:
- 화자 오판: 90% 이상 제거
- ATM/자동 시스템 정확 인식
- 핵심 사건 누락: 70% 이상 감소

**일관성**:
- N개 요약 중 최고 품질 선택
- 변동성 감소

---

## 6. 실행 계획

### 즉시 실행 (오늘)

1. **프롬프트 v3.0 구현** (`src/api/solar_api.py`)
2. **추론 명령어 업데이트**:
   ```bash
   python scripts/kfold_ensemble_inference.py \
     --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
     --test_data data/raw/test.csv \
     --use_solar_api \
     --solar_model solar-1-chat \
     --max_new_tokens 120 \
     --min_new_tokens 40 \
     --length_penalty 0.9 \
     --repetition_penalty 1.3 \
     --batch_size 32
   ```
3. **결과 검증**:
   - test_28 요약 확인
   - 평균 길이 확인
   - 플레이스홀더 검사

### 다음 단계 (내일)

1. Solar API 다중 실행 시스템 구현
2. 품질 평가 함수 구현
3. 실험 및 비교

---

**검토 필요**: Yes
**우선순위**: 🔴 Critical (즉시 적용 필요)
