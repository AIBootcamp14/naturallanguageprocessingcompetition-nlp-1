# Solar API 심각한 문제점 발견 및 해결 (2025-10-15)

**날짜**: 2025-10-15 오후
**실험**: `20251015_110257_inference_kobart_kfold_soft_voting_maxnew110_hf_solar`
**실험 (실패)**: `20251015_120129_inference_kobart_kfold_soft_voting_maxnew110_hf_solar`

---

## 🚨 발견된 심각한 문제점

### 문제 1: "친구 A와 친구 B" 패턴 여전히 출현

**증거 (로그 line 107-108)**:
```
샘플 1/2: 75.0점 | 친구 A와 친구 B가 출퇴근 교통체증과 환경 문제에 대해 대화하며...
```

**문제점**:
- v3.3 프롬프트에서 명시적으로 금지했음에도 Solar API가 무시
- "두 친구", "친구들" 대신 여전히 "친구 A와 친구 B" 생성
- **총 20회 이상 발견** (line 107, 108, 173, 174, 275, 276, 279, 280, 345, 363, 364, 387, 388, 489, 490, 523...)

**영향**:
- 프롬프트 엔지니어링이 Solar API에 제대로 적용되지 않음
- Post-processing도 이를 제거하지 못함 (프롬프트에서 생성된 것이므로)

---

### 문제 2: "친구 Francis" - 불필요한 역할 명칭 추가

**증거 (로그 line 149-150)**:
```
친구 Francis가 생일 파티에 참석한 친구에게 감사를 표하고...
```

**문제점**:
- "Francis"라는 이름이 명시되어 있는데 앞에 "친구"가 추가됨
- **올바른 표현**: "Francis가 생일 파티에 참석한 친구에게..."
- 이름만 사용하면 되는데 "친구 + 이름" 형태로 중복

**프롬프트 위반**:
```python
✅ **필수 준수사항 (MUST COMPLY)**:
- **명시된 이름 최우선**: "Ms. Dawson", "스티븐", "Tom", "Mary" 등 → 반드시 사용
```

---

### 문제 3: "상사 Mr. Polly" - 역할 오판

**증거 (로그 line 229-230)**:
```
상사 Mr. Polly가 직원 A에게 잠시 일을 쉬고 싶다고 말하자, A는 음료수를 사러...
```

**원본 대화 (test_30)**:
```
#Person1#: Mr. Polly, 무슨 일 있으세요?
#Person2#: 무슨 일이냐고요? 이 끔찍한 일을 잠시 쉬고 싶다고요.
#Person1#: 그럼, 음료수 한 병 사세요.
#Person2#: 저를 위해 가게에서 한 병 사줄래요?
#Person1#: 문제네요, 그 가게에 제 상사가 있어요.
#Person2#: 알겠습니다, 제가 직접 갈게요.
```

**올바른 분석**:
- Person1: 부탁을 들어주려 하는 사람 (동료/지인)
- Person2: Mr. Polly (부탁하는 사람, 동료/지인)
- "제 상사" = Person1의 상사 (대화에 등장하지 않는 제3자)

**Solar API 오판**:
- ❌ "상사 Mr. Polly" - Mr. Polly를 상사로 잘못 인식
- ❌ "직원 A" - Person1을 직원으로 잘못 인식
- ✅ 올바른 표현: "Mr. Polly가 동료에게 음료수를 사달라고 부탁하지만, 동료는 그 가게에 자신의 상사가 있어 거절하고..."

**STEP 1 역할 구조 분석 실패**:
- 지시 관계를 잘못 파악 ("사달라고" ≠ 상사의 명령)
- 대화 내용 키워드 무시 ("제 상사가 있어요" 간과)

---

### 문제 4: Solar API 클라이언트 초기화 실패

**증거 (로그 20251015_120129)**:
```
❌ 배치 요약 중 오류 발생: Solar API 클라이언트가 초기화되지 않음
```

**원인 분석**:
1. `SOLAR_API_KEY` 환경 변수 미설정
2. 또는 API 키 로딩 시점 문제

**영향**:
- v3.3 코드로 실행한 실험이 즉시 실패
- Solar API 기능 완전히 비활성화

---

## 🔍 근본 원인 분석

### 1. Solar API 프롬프트 무시 문제

**가설 1: 프롬프트 길이 초과**
- 현재 프롬프트가 너무 길어서 Solar API가 일부만 처리
- 특히 시스템 메시지의 하단부 무시 가능성

**가설 2: 프롬프트 구조 문제**
- 금지 사항과 예시가 분리되어 있음
- Solar API가 예시에만 집중하고 금지 사항 무시

**가설 3: Temperature/Top-p 설정**
- voting에서 temperature=0.3, top_p=0.5
- 너무 높아서 창의적 출력 허용 (플레이스홀더 생성)

### 2. 역할 분석 실패

**현상**:
- STEP 1 역할 구조 분석이 제대로 작동하지 않음
- "Mr. Polly"를 상사로 오판
- 대화 내용 ("제 상사가 있어요") 무시

**원인**:
- Solar API가 복잡한 5-STEP 분석을 따라가지 못함
- 단순히 첫 번째 Person을 상급자로 가정

### 3. 이름 처리 문제

**현상**:
- "친구 Francis" - 불필요한 역할 추가
- 이름이 있어도 역할을 앞에 붙임

**원인**:
- 프롬프트의 우선순위 규칙 무시
- "명시된 이름 최우선" 규칙이 적용되지 않음

---

## ✅ 해결 방안

### 방안 1: 프롬프트 대폭 간소화 및 재구성

**핵심 전략**:
1. **짧고 명확한 금지 사항** (상단 배치)
2. **예시 기반 학습** (Few-shot learning 강화)
3. **복잡한 STEP 제거** → 간단한 규칙으로 대체

**새로운 프롬프트 구조**:
```
[1] CRITICAL 금지 사항 (3줄 이내)
[2] 핵심 규칙 (5줄 이내)
[3] 구체적 예시 10개 (Before/After)
[4] 품질 체크리스트 (3줄)
```

### 방안 2: Temperature 대폭 감소

**현재**: `temperature=0.3, top_p=0.5`
**변경**: `temperature=0.1, top_p=0.3`

**이유**:
- 더 결정적(deterministic)인 출력 필요
- 창의성보다 규칙 준수가 우선

### 방안 3: Post-processing 강화

**현재 문제**:
- "친구 A와 친구 B" 패턴이 Post-processing에서 제거되지 않음
- 단순 regex로는 불충분

**개선 방안**:
```python
# 1. "친구 A와 친구 B" → "두 친구"
modified = re.sub(r'(친구|동료|연인)\s+([A-D])와\s+\1\s+([A-D])가', r'두 \1가', modified)

# 2. "친구 Francis" → "Francis" (이름 앞 역할 제거)
modified = re.sub(r'(친구|동료|상사|직원)\s+([A-Z][a-z]+)(?=[가이와과에한])', r'\2', modified)

# 3. "상사 Mr. Polly" → "Mr. Polly"
modified = re.sub(r'(상사|직원|고객)\s+(Mr\.|Ms\.|Mrs\.)\s+([A-Z][a-z]+)', r'\2 \3', modified)
```

### 방안 4: API 키 체크 강화

**문제**: 런타임에 API 키 없음 에러
**해결**: 스크립트 시작 시 즉시 체크

```python
# scripts/kfold_ensemble_inference.py 상단에 추가
if args.use_solar_api:
    import os
    if not os.getenv("SOLAR_API_KEY"):
        raise RuntimeError("❌ SOLAR_API_KEY 환경 변수가 설정되지 않았습니다!")
    print(f"✅ SOLAR_API_KEY 확인됨: {os.getenv('SOLAR_API_KEY')[:8]}...")
```

---

## 📊 문제 심각도 분석

| 문제 | 심각도 | 영향 | 우선순위 |
|------|--------|------|----------|
| "친구 A와 친구 B" 여전히 출현 | 🔴 높음 | 20회+ 발견, 품질 저하 | **1순위** |
| "친구 Francis" 중복 역할 | 🟡 중간 | 10회+ 발견, 부자연스러움 | **2순위** |
| "상사 Mr. Polly" 역할 오판 | 🔴 높음 | 의미 왜곡, 치명적 | **1순위** |
| API 클라이언트 초기화 실패 | 🔴 치명적 | 실험 실행 불가 | **0순위** |

---

## 🎯 즉시 실행 계획

### Step 1: API 키 문제 해결 (5분)
- [x] 환경 변수 체크 코드 추가
- [ ] 스크립트에 early validation 추가

### Step 2: Post-processing 강화 (15분)
- [ ] "친구 A와 친구 B" 패턴 제거 regex 추가
- [ ] "친구 Francis" → "Francis" 변환 regex 추가
- [ ] "상사 Mr. Polly" → "Mr. Polly" 변환 regex 추가

### Step 3: 프롬프트 재설계 (30분)
- [ ] 현재 프롬프트 50% 축소
- [ ] 금지 사항을 최상단으로 이동
- [ ] 예시를 Before/After 형태로 10개 추가
- [ ] STEP 1-5 제거 → 간단한 3단계 규칙으로 대체

### Step 4: Temperature 조정 (1분)
- [ ] 0.3 → 0.1
- [ ] top_p 0.5 → 0.3

### Step 5: 테스트 (10분)
- [ ] 작은 샘플 (10개)로 테스트
- [ ] 문제 패턴 확인
- [ ] 전체 실험 실행

---

## 📝 학습한 교훈

1. **프롬프트 엔지니어링의 한계**
   - 아무리 자세한 프롬프트도 LLM이 무시할 수 있음
   - 간결하고 명확한 규칙이 더 효과적

2. **Post-processing의 중요성**
   - 프롬프트만으로는 불충분
   - 강력한 Post-processing이 필수

3. **역할 분석의 어려움**
   - 복잡한 5-STEP 분석은 LLM이 따라가기 어려움
   - 간단한 휴리스틱이 더 신뢰할 수 있음

4. **API 초기화 체크 필요**
   - 런타임 에러보다 즉시 실패가 나음
   - Early validation 필수

---

## 🔗 관련 문서

- `docs/issues/Solar_API_플레이스홀더_제거_v2.md` (이전 시도)
- `docs/usage/명령어_검증_solar_pro2.md` (명령어 검증)
- `src/api/solar_api.py` (현재 구현)
