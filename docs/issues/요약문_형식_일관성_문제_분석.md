# 요약문 형식 일관성 문제 분석 및 해결

> **발견일**: 2025-10-15
> **심각도**: 🟡 Medium (접두사 문제만 실제 해결 필요)
> **영향 범위**: Solar API/HF 보정 미사용 시 `#Person1#` 그대로 유지되는 문제

---

## 📋 목차

1. [문제 개요](#1-문제-개요)
2. [발견된 문제점 상세](#2-발견된-문제점-상세)
3. [근본 원인 분석](#3-근본-원인-분석)
4. [해결 방법](#4-해결-방법)
5. [구현 결과](#5-구현-결과)

---

## 1. 문제 개요

### 1.1 초기 오해

**잘못된 판단**:
```
❌ "#Person1#", "#Person2#"를 그대로 유지하는 것이 문제
❌ A/B로 변경되는 것이 문제
❌ 후처리에서 명칭을 강제 변환해야 함
```

**실제 상황**:
```
✅ Solar API/HF 모델이 상황을 인지하여 자동으로 적절한 명칭 사용
✅ "#Person1#", "#Person2#" → "고객", "은행원", "의사", "환자" 등으로 맥락 기반 변환
✅ 이는 오히려 품질 향상에 도움이 됨
```

### 1.2 실제 문제

**진짜 문제**:
- **접두사 삽입**: "대화 요약:", "Summary:" 등의 메타 레이블
- **Solar API/HF 미사용 시**: `#Person1#`, `#Person2#`가 그대로 남음

**문제 없는 경우**:
- Solar API/HF 모델이 상황 인지하여 명칭 변환 → **정상 동작**

---

## 2. 발견된 문제점 상세

### 2.1 불필요한 접두사 삽입 (실제 문제)

#### 문제 예시

```
❌ 잘못된 예시:
"대화 요약: 고객은 은행과 증권사 간 자금 이체 서비스에 대해 문의한다."
"대화 내용 요약: 의사는 환자에게 건강검진의 중요성을 설명한다."
"Summary: 직원이 손님에게 신규 서비스를 안내한다."
```

```
✅ 올바른 예시:
"고객은 은행과 증권사 간 자금 이체 서비스에 대해 문의한다."
"의사는 환자에게 건강검진의 중요성을 설명한다."
"직원이 손님에게 신규 서비스를 안내한다."
```

#### 발견된 패턴
- `대화 요약:`
- `대화 내용 요약:`
- `대화 요약:\n` (줄바꿈 포함)
- `Summary:`
- `요약:`

#### 영향
- 제출 파일에 불필요한 메타 정보 포함
- 요약문 시작 부분 가독성 저하
- 평가 시 ROUGE 점수 하락 가능성

---

### 2.2 상황 인지 기반 명칭 변환 (정상 동작) ✅

#### 예시 분석

**test_366 케이스**:

**원본 대화**:
```
#Person1#: 안녕하세요. 오늘 뭘 도와드릴까요?
#Person2#: 당신들한테서 우편으로 받은 전단지 중 하나에서 새로운 서비스에 대해 봤어요...
```

**Solar API + HF 보정 결과** (20251015_001946):
```
✅ 우수한 결과:
"고객은 우편으로 받은 전단지에서 은행과 증권사 간 자금 이체 서비스에 대해 알게 되었다.
이 서비스는 주식 투자자에게 추가 혜택을 제공하며, 최신 증권 거래소 시세와 투자 계획에
대한 맞춤형 상담 서비스를 제공한다. 고객은 직접 지점에 방문하지 않고도 전화나 인터넷을
통해 상담 서비스를 이용할 수 있다."
```

**Solar API/HF 미사용 결과** (20251015_004408):
```
❌ 문제 있는 결과:
"#Person2#는 은행과 증권 간의 자금 이체를 위한 새로운 서비스를 소개하며, 맞춤형 상담
서비스를 제공한다고 설명합니다. 또한 전화로는 상담 서비스를 받을 수 없다고 언급합니다.
##Person1# 씨는 전화로도 상담이 가능하다고 안내합니다..."
```

#### 결론

**Solar API/HF 모델의 역할**:
- ✅ **상황 인지**: 대화 맥락을 파악하여 적절한 명칭 사용
- ✅ **자연스러운 표현**: "고객", "은행원", "의사", "환자" 등
- ✅ **품질 향상**: 기계적 `#Person1#` 표현보다 읽기 쉬움

**후처리의 역할**:
- ✅ **형식 정제**: 접두사 제거, 불완전한 문장 정리
- ❌ **명칭 변환하지 않음**: 모델이 이미 잘 처리함

---

### 2.3 train.csv 데이터 분석

**학습 데이터 명칭 사용 패턴**:

```csv
train_0:
대화: "#Person1#: 안녕하세요, Mr. Smith. 저는 Dr. Hawkins입니다..."
요약: "Mr. Smith는 Dr. Hawkins에게 건강검진을 받으러 와서, 매년 검진 필요성을
      안내받고 흡연 습관 개선을 위한 도움을 제안받았습니다."
```

**학습 데이터의 특징**:
1. **대화문**: `#Person1#`, `#Person2#` 사용
2. **요약문**:
   - 실제 이름이 있으면 실제 이름 사용 (Mr. Smith, Dr. Hawkins)
   - 실제 이름이 없으면 **상황에 맞는 명칭** 사용
   - `#Person1#`, `#Person2#`는 거의 사용하지 않음

**결론**:
- 모델이 학습 데이터로부터 **상황 인지 기반 명칭 사용**을 학습함
- Solar API/HF 모델이 이를 더 잘 수행함
- 후처리에서 강제 변환하면 오히려 **품질 저하**

---

## 3. 근본 원인 분석

### 3.1 Solar API/HF 모델의 장점

**Solar API/HF 모델이 하는 일**:
```
1. 대화 맥락 분석
   - 은행 업무 → "고객", "은행원"
   - 병원 진료 → "환자", "의사"
   - 식당 서비스 → "손님", "직원"

2. 자연스러운 표현 생성
   - 기계적: "#Person1#는 #Person2#에게..."
   - 자연스럽게: "고객은 은행원에게..."

3. 읽기 쉬운 요약문 생성
   - 평가자가 이해하기 쉬움
   - ROUGE 점수 향상
```

### 3.2 Solar API/HF 미사용 시 문제

**KoBART 단독 사용 시**:
```
문제: #Person1#, #Person2#가 그대로 유지됨
원인: 학습 데이터에서 본 패턴을 그대로 사용
결과: 읽기 어려운 요약문
```

**해결책**:
- ✅ **Solar API/HF 모델 사용** (권장)
- ⚠️ 후처리에서 강제 변환 (비권장 - 맥락 무시)

### 3.3 접두사 삽입 문제

**원인**:
```
Solar API가 학습 중 본 패턴:
- 일부 학습 데이터에 "요약:", "Summary:" 형태 존재
- 요약 태스크 프롬프트에서 이런 형식 사용
→ 생성 시 가끔 포함됨
```

**영향**:
- 평가 시 불필요한 토큰으로 인식
- ROUGE 점수 하락 가능

---

## 4. 해결 방법

### 4.1 접두사 제거 (구현 완료)

#### 구현 위치
`src/inference/predictor.py:postprocess_summary()`

#### 구현 코드

```python
def postprocess_summary(text: str) -> str:
    """
    요약문 후처리: 불완전한 문장을 정제하여 완전한 문장으로 변환

    주요 처리 과정:
    0. 불필요한 접두사 제거 ("대화 요약:", "Summary:" 등)  # ← 추가됨
    1. 반복된 점들 제거 ("... . . ." 패턴)
    2. 불완전한 플레이스홀더 제거 (모든 패턴)
    3. 불완전한 마지막 문장 제거 (끊긴 문장 삭제)
    4. 불완전한 종결어 제거
    5. 문장 종결 보장 (마침표가 없으면 추가)
    """
    text = text.strip()
    if not text:
        return text

    # -------------- 0. 불필요한 접두사 제거 -------------- #
    patterns = [
        r'^대화\s*(내용)?\s*요약\s*:\s*',
        r'^Summary\s*:\s*',
        r'^요약\s*:\s*',
        r'^대화\s*:\s*',
    ]
    for pattern in patterns:
        text = re.sub(pattern, '', text, flags=re.IGNORECASE)
    text = text.lstrip('\n ')

    # 나머지 후처리 계속...
    # (반복 제거, 불완전 문장 제거 등)

    return text
```

### 4.2 명칭 변환은 모델에게 맡기기 (권장)

#### 방법 1: Solar API + HF 보정 사용 (✅ 최고 품질)

```bash
python scripts/inference.py \
  --model experiments/.../kobart/final_model \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --correction_strategy quality_based \
  --batch_size 16
```

**장점**:
- ✅ 상황 인지 기반 명칭 자동 변환
- ✅ 자연스러운 표현
- ✅ 높은 ROUGE 점수

#### 방법 2: KoBART 단독 + 접두사 제거만 (기본)

```bash
python scripts/inference.py \
  --model experiments/.../kobart/final_model \
  --test_data data/raw/test.csv \
  --batch_size 16
```

**특징**:
- `#Person1#`, `#Person2#` 그대로 유지
- 접두사만 제거됨
- 속도는 빠르지만 품질은 떨어짐

#### 방법 3: 후처리에서 강제 변환 (❌ 비권장)

**하지 말아야 할 이유**:
```
1. 맥락 무시:
   - 은행원인지 고객인지 판단 불가
   - 의사인지 환자인지 알 수 없음

2. 품질 저하:
   - 기계적 변환: "#Person1# → A"
   - 자연스럽지 않음

3. 모델이 더 잘함:
   - Solar API가 이미 최적화됨
   - 억지로 바꾸면 오히려 나빠짐
```

---

## 5. 구현 결과

### 5.1 수정 사항

| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| **접두사 처리** | ❌ 제거 안 함 | ✅ 자동 제거 |
| **명칭 변환** | ❌ 강제 변환 시도 | ✅ 모델에 맡김 |
| **후처리 역할** | ❌ 과도한 개입 | ✅ 형식 정제만 |

### 5.2 테스트 결과

```python
# 접두사 제거 테스트
test_cases = [
    ('대화 요약: 고객은 은행원에게 문의한다.', '고객은 은행원에게 문의한다.'),
    ('Summary: 의사는 환자에게 설명한다.', '의사는 환자에게 설명한다.'),
    ('대화 내용 요약: 직원이 손님을 안내한다.', '직원이 손님을 안내한다.'),
    ('고객이 상담을 받는다.', '고객이 상담을 받는다.'),  # 접두사 없음
]

# 결과: ✅ 모든 테스트 통과 (4/4)
```

### 5.3 예상 효과

#### Solar API + HF 보정 사용 시

| 지표 | 개선 효과 |
|------|----------|
| **접두사 제거** | 100% 해결 |
| **명칭 자연스러움** | 상황 인지 기반 변환 |
| **ROUGE 점수** | +3-5% 향상 예상 |
| **가독성** | 크게 향상 |

#### KoBART 단독 사용 시

| 지표 | 효과 |
|------|------|
| **접두사 제거** | 100% 해결 |
| **명칭 표현** | `#Person1#` 유지 (개선 없음) |
| **ROUGE 점수** | 접두사 제거로 소폭 향상 |

---

## 6. 핵심 교훈

### 6.1 올바른 이해

```
✅ Solar API/HF 모델의 상황 인지 능력을 신뢰
✅ 후처리는 형식 정제에만 집중
✅ 명칭 변환은 모델이 더 잘함
```

### 6.2 잘못된 접근

```
❌ 후처리에서 모든 것을 해결하려고 시도
❌ 맥락 없이 기계적으로 명칭 변환
❌ 모델의 판단을 무시하고 강제 수정
```

### 6.3 권장 사항

**최고 품질을 원한다면**:
```bash
# Solar API + HF 보정 사용
python scripts/inference.py \
  --model ... \
  --use_solar_api \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization
```

**빠른 추론이 필요하다면**:
```bash
# KoBART 단독 사용 (접두사는 자동 제거됨)
python scripts/inference.py \
  --model ...
```

---

## 7. 관련 파일

### 7.1 수정된 파일
- `src/inference/predictor.py`: 접두사 제거 로직 추가 (line 65-75)

### 7.2 관련 문서
- `docs/모듈화/04_02_KoBART_단일모델_최강_성능_전략.md`: Solar API 사용 가이드

### 7.3 참고 데이터
- `data/processed/train_with_augmentation_20251011_112913.csv`: 학습 데이터 명칭 패턴
- `experiments/20251015/20251015_001946_.../`: Solar API 사용 결과 (우수)
- `experiments/20251015/20251015_004408_.../`: KoBART 단독 결과 (개선 필요)

---

**작성일**: 2025-10-15
**최종 수정**: 2025-10-15
**상태**: ✅ 해결 완료 (접두사 제거)
