# 요약문 형식 일관성 문제 분석 및 해결

> **발견일**: 2025-10-15
> **심각도**: 🟡 Medium (접두사 문제만 실제 해결 필요)
> **영향 범위**: Solar API/HF 보정 미사용 시 `#Person1#` 그대로 유지되는 문제

---

## 📋 목차

1. [문제 개요](#1-문제-개요)
2. [발견된 문제점 상세](#2-발견된-문제점-상세)
3. [근본 원인 분석](#3-근본-원인-분석)
4. [해결 방법](#4-해결-방법)
5. [구현 결과](#5-구현-결과)

---

## 1. 문제 개요

### 1.1 초기 오해

**잘못된 판단**:
```
❌ "#Person1#", "#Person2#"를 그대로 유지하는 것이 문제
❌ A/B로 변경되는 것이 문제
❌ 후처리에서 명칭을 강제 변환해야 함
```

**실제 상황**:
```
✅ Solar API/HF 모델이 상황을 인지하여 자동으로 적절한 명칭 사용
✅ "#Person1#", "#Person2#" → "고객", "은행원", "의사", "환자" 등으로 맥락 기반 변환
✅ 이는 오히려 품질 향상에 도움이 됨
```

### 1.2 실제 문제

**진짜 문제**:
- **접두사 삽입**: "대화 요약:", "Summary:" 등의 메타 레이블
- **Solar API/HF 미사용 시**: `#Person1#`, `#Person2#`가 그대로 남음

**문제 없는 경우**:
- Solar API/HF 모델이 상황 인지하여 명칭 변환 → **정상 동작**

---

## 2. 발견된 문제점 상세

### 2.1 불필요한 접두사 삽입 (실제 문제)

#### 문제 예시

```
❌ 잘못된 예시:
"대화 요약: 고객은 은행과 증권사 간 자금 이체 서비스에 대해 문의한다."
"대화 내용 요약: 의사는 환자에게 건강검진의 중요성을 설명한다."
"Summary: 직원이 손님에게 신규 서비스를 안내한다."
```

```
✅ 올바른 예시:
"고객은 은행과 증권사 간 자금 이체 서비스에 대해 문의한다."
"의사는 환자에게 건강검진의 중요성을 설명한다."
"직원이 손님에게 신규 서비스를 안내한다."
```

#### 발견된 패턴
- `대화 요약:`
- `대화 내용 요약:`
- `대화 요약:\n` (줄바꿈 포함)
- `Summary:`
- `요약:`

#### 영향
- 제출 파일에 불필요한 메타 정보 포함
- 요약문 시작 부분 가독성 저하
- 평가 시 ROUGE 점수 하락 가능성

---

### 2.2 상황 인지 기반 명칭 변환 (정상 동작) ✅

#### 예시 분석

**test_366 케이스**:

**원본 대화**:
```
#Person1#: 안녕하세요. 오늘 뭘 도와드릴까요?
#Person2#: 당신들한테서 우편으로 받은 전단지 중 하나에서 새로운 서비스에 대해 봤어요...
```

**Solar API + HF 보정 결과** (20251015_001946):
```
✅ 우수한 결과:
"고객은 우편으로 받은 전단지에서 은행과 증권사 간 자금 이체 서비스에 대해 알게 되었다.
이 서비스는 주식 투자자에게 추가 혜택을 제공하며, 최신 증권 거래소 시세와 투자 계획에
대한 맞춤형 상담 서비스를 제공한다. 고객은 직접 지점에 방문하지 않고도 전화나 인터넷을
통해 상담 서비스를 이용할 수 있다."
```

**Solar API/HF 미사용 결과** (20251015_004408):
```
❌ 문제 있는 결과:
"#Person2#는 은행과 증권 간의 자금 이체를 위한 새로운 서비스를 소개하며, 맞춤형 상담
서비스를 제공한다고 설명합니다. 또한 전화로는 상담 서비스를 받을 수 없다고 언급합니다.
##Person1# 씨는 전화로도 상담이 가능하다고 안내합니다..."
```

#### 결론

**Solar API/HF 모델의 역할**:
- ✅ **상황 인지**: 대화 맥락을 파악하여 적절한 명칭 사용
- ✅ **자연스러운 표현**: "고객", "은행원", "의사", "환자" 등
- ✅ **품질 향상**: 기계적 `#Person1#` 표현보다 읽기 쉬움

**후처리의 역할**:
- ✅ **형식 정제**: 접두사 제거, 불완전한 문장 정리
- ❌ **명칭 변환하지 않음**: 모델이 이미 잘 처리함

---

### 2.3 train.csv 데이터 분석

**학습 데이터 명칭 사용 패턴**:

```csv
train_0:
대화: "#Person1#: 안녕하세요, Mr. Smith. 저는 Dr. Hawkins입니다..."
요약: "Mr. Smith는 Dr. Hawkins에게 건강검진을 받으러 와서, 매년 검진 필요성을
      안내받고 흡연 습관 개선을 위한 도움을 제안받았습니다."
```

**학습 데이터의 특징**:
1. **대화문**: `#Person1#`, `#Person2#` 사용
2. **요약문**:
   - 실제 이름이 있으면 실제 이름 사용 (Mr. Smith, Dr. Hawkins)
   - 실제 이름이 없으면 **상황에 맞는 명칭** 사용
   - `#Person1#`, `#Person2#`는 거의 사용하지 않음

**결론**:
- 모델이 학습 데이터로부터 **상황 인지 기반 명칭 사용**을 학습함
- Solar API/HF 모델이 이를 더 잘 수행함
- 후처리에서 강제 변환하면 오히려 **품질 저하**

---

## 3. 근본 원인 분석

### 3.1 Solar API/HF 모델의 장점

**Solar API/HF 모델이 하는 일**:
```
1. 대화 맥락 분석
   - 은행 업무 → "고객", "은행원"
   - 병원 진료 → "환자", "의사"
   - 식당 서비스 → "손님", "직원"

2. 자연스러운 표현 생성
   - 기계적: "#Person1#는 #Person2#에게..."
   - 자연스럽게: "고객은 은행원에게..."

3. 읽기 쉬운 요약문 생성
   - 평가자가 이해하기 쉬움
   - ROUGE 점수 향상
```

### 3.2 Solar API/HF 미사용 시 문제

**KoBART 단독 사용 시**:
```
문제: #Person1#, #Person2#가 그대로 유지됨
원인: 학습 데이터에서 본 패턴을 그대로 사용
결과: 읽기 어려운 요약문
```

**해결책**:
- ✅ **Solar API/HF 모델 사용** (권장)
- ⚠️ 후처리에서 강제 변환 (비권장 - 맥락 무시)

### 3.3 접두사 삽입 문제

**원인**:
```
Solar API가 학습 중 본 패턴:
- 일부 학습 데이터에 "요약:", "Summary:" 형태 존재
- 요약 태스크 프롬프트에서 이런 형식 사용
→ 생성 시 가끔 포함됨
```

**영향**:
- 평가 시 불필요한 토큰으로 인식
- ROUGE 점수 하락 가능

---

## 4. 해결 방법

### 4.1 접두사 제거 (구현 완료)

#### 구현 위치
`src/inference/predictor.py:postprocess_summary()`

#### 구현 코드

```python
def postprocess_summary(text: str) -> str:
    """
    요약문 후처리: 불완전한 문장을 정제하여 완전한 문장으로 변환

    주요 처리 과정:
    0. 불필요한 접두사 제거 ("대화 요약:", "Summary:" 등)  # ← 추가됨
    1. 반복된 점들 제거 ("... . . ." 패턴)
    2. 불완전한 플레이스홀더 제거 (모든 패턴)
    3. 불완전한 마지막 문장 제거 (끊긴 문장 삭제)
    4. 불완전한 종결어 제거
    5. 문장 종결 보장 (마침표가 없으면 추가)
    """
    text = text.strip()
    if not text:
        return text

    # -------------- 0. 불필요한 접두사 제거 -------------- #
    patterns = [
        r'^대화\s*(내용)?\s*요약\s*:\s*',
        r'^Summary\s*:\s*',
        r'^요약\s*:\s*',
        r'^대화\s*:\s*',
    ]
    for pattern in patterns:
        text = re.sub(pattern, '', text, flags=re.IGNORECASE)
    text = text.lstrip('\n ')

    # 나머지 후처리 계속...
    # (반복 제거, 불완전 문장 제거 등)

    return text
```

### 4.2 명칭 변환은 모델에게 맡기기 (권장)

#### 방법 1: Solar API + HF 보정 사용 (✅ 최고 품질)

```bash
python scripts/inference.py \
  --model experiments/.../kobart/final_model \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --correction_strategy quality_based \
  --batch_size 16
```

**장점**:
- ✅ 상황 인지 기반 명칭 자동 변환
- ✅ 자연스러운 표현
- ✅ 높은 ROUGE 점수

#### 방법 2: KoBART 단독 + 접두사 제거만 (기본)

```bash
python scripts/inference.py \
  --model experiments/.../kobart/final_model \
  --test_data data/raw/test.csv \
  --batch_size 16
```

**특징**:
- `#Person1#`, `#Person2#` 그대로 유지
- 접두사만 제거됨
- 속도는 빠르지만 품질은 떨어짐

#### 방법 3: 후처리에서 강제 변환 (❌ 비권장)

**하지 말아야 할 이유**:
```
1. 맥락 무시:
   - 은행원인지 고객인지 판단 불가
   - 의사인지 환자인지 알 수 없음

2. 품질 저하:
   - 기계적 변환: "#Person1# → A"
   - 자연스럽지 않음

3. 모델이 더 잘함:
   - Solar API가 이미 최적화됨
   - 억지로 바꾸면 오히려 나빠짐
```

---

## 5. 구현 결과

### 5.1 수정 사항

| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| **접두사 처리** | ❌ 제거 안 함 | ✅ 자동 제거 |
| **명칭 변환** | ❌ 강제 변환 시도 | ✅ 모델에 맡김 |
| **후처리 역할** | ❌ 과도한 개입 | ✅ 형식 정제만 |

### 5.2 테스트 결과

```python
# 접두사 제거 테스트
test_cases = [
    ('대화 요약: 고객은 은행원에게 문의한다.', '고객은 은행원에게 문의한다.'),
    ('Summary: 의사는 환자에게 설명한다.', '의사는 환자에게 설명한다.'),
    ('대화 내용 요약: 직원이 손님을 안내한다.', '직원이 손님을 안내한다.'),
    ('고객이 상담을 받는다.', '고객이 상담을 받는다.'),  # 접두사 없음
]

# 결과: ✅ 모든 테스트 통과 (4/4)
```

### 5.3 예상 효과

#### Solar API + HF 보정 사용 시

| 지표 | 개선 효과 |
|------|----------|
| **접두사 제거** | 100% 해결 |
| **명칭 자연스러움** | 상황 인지 기반 변환 |
| **ROUGE 점수** | +3-5% 향상 예상 |
| **가독성** | 크게 향상 |

#### KoBART 단독 사용 시

| 지표 | 효과 |
|------|------|
| **접두사 제거** | 100% 해결 |
| **명칭 표현** | `#Person1#` 유지 (개선 없음) |
| **ROUGE 점수** | 접두사 제거로 소폭 향상 |

---

## 6. 핵심 교훈

### 6.1 올바른 이해

```
✅ Solar API/HF 모델의 상황 인지 능력을 신뢰
✅ 후처리는 형식 정제에만 집중
✅ 명칭 변환은 모델이 더 잘함
```

### 6.2 잘못된 접근

```
❌ 후처리에서 모든 것을 해결하려고 시도
❌ 맥락 없이 기계적으로 명칭 변환
❌ 모델의 판단을 무시하고 강제 수정
```

### 6.3 권장 사항

**최고 품질을 원한다면**:
```bash
# Solar API + HF 보정 사용
python scripts/inference.py \
  --model ... \
  --use_solar_api \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization
```

**빠른 추론이 필요하다면**:
```bash
# KoBART 단독 사용 (접두사는 자동 제거됨)
python scripts/inference.py \
  --model ...
```

---

## 7. 관련 파일

### 7.1 수정된 파일
- `src/inference/predictor.py`: 접두사 제거 로직 추가 (line 65-75)

### 7.2 관련 문서
- `docs/모듈화/04_02_KoBART_단일모델_최강_성능_전략.md`: Solar API 사용 가이드

### 7.3 참고 데이터
- `data/processed/train_with_augmentation_20251011_112913.csv`: 학습 데이터 명칭 패턴
- `experiments/20251015/20251015_001946_.../`: Solar API 사용 결과 (우수)
- `experiments/20251015/20251015_004408_.../`: KoBART 단독 결과 (개선 필요)

---

---

## 8. 추가 발견 문제 (2025-10-15 오전 심층 분석)

### 8.1 분석 개요

**분석 대상**:
- 제출 파일: `20251015_031503_inference_kobart_kfold_soft_voting_bs32_maxnew60_hf_solar.csv`
- 테스트 데이터: `data/raw/test.csv` (499개 샘플)
- 분석 도구: `src/analysis/analyze_summaries.py`

**발견된 주요 문제**:

| 문제 유형 | 발생 건수 | 비율 | 심각도 |
|----------|----------|------|--------|
| 접두사 미제거 | 3건 | 0.6% | 🟢 Low |
| 요약 미실행 | 0건 | 0.0% | 🟢 None |
| 요약문이 원본보다 긴 경우 | 1건 | 0.2% | 🟡 Medium |
| 일반 명칭 사용 (A/B) | 8건 | 1.6% | 🟡 Medium |
| **화자 명칭 오류** | **78건** | **15.6%** | 🔴 **High** |

---

### 8.2 문제 1: 접두사 미제거 (3건, 0.6%)

#### 발견된 패턴

**여전히 남아있는 접두사**:
1. `대화에서는` - 2건 (test_100, test_227)
2. `대화 상대` - 1건 (test_315)

#### 사례 분석

```
test_100:
"대화에서 A는 도널드 트럼프를 대통령으로 지지하지 않고 조 바이든을 지지하는 반면..."

test_227:
"대화에서 A와 B는 각자의 나라에서 인기 있는 스포츠에 대해 이야기한다..."

test_315:
"대화 상대 A와 B는 B의 언어 능력에 대해 이야기한다..."
```

#### 원인 분석

현재 `src/inference/predictor.py`의 접두사 패턴이 이러한 변형을 포착하지 못함:

```python
# 현재 패턴 (불충분)
patterns = [
    r'^대화\s*(내용)?\s*요약\s*[:：]\s*\n*',
    r'^Summary\s*[:：]\s*\n*',
    r'^요약\s*[:：]\s*\n*',
    r'^대화\s*[:：]\s*\n*',
    # ❌ "대화에서는", "대화 상대" 패턴 누락
]
```

#### 해결 방안

```python
# 개선된 패턴 (필요)
patterns = [
    r'^대화\s*(내용)?\s*요약\s*[:：]\s*\n*',
    r'^Summary\s*[:：]\s*\n*',
    r'^요약\s*[:：]\s*\n*',
    r'^대화\s*[:：]\s*\n*',
    r'^대화\s*상대\s+[A-Z가-힣]*\s*(가|는|이|을|를)\s*',  # ← 추가
    r'^대화에서는?\s+',  # ← 추가
    r'^대화\s*참여자들은?\s+',  # ← 추가
]
```

**예상 효과**: 3건 모두 해결 (0.6% → 0%)

---

### 8.3 문제 2: 일반 명칭 사용 (8건, 1.6%)

#### 발견된 패턴

| 패턴 | 건수 |
|------|------|
| `\b[A-D]\b` (단일 알파벳) | 7건 |
| `#Person\d+#` | 1건 |

#### 사례 분석

**test_18**:
```
"학생(A)이 학교 사무실에 연락하여 두통을 호소했고, 상담사(B)는..."
```

**test_49**:
```
"감독 A는 배우 Mike(B)에게 캐릭터의 반응이 더 화난 느낌이어야 한다고..."
```

**test_215**:
```
"의사는 #Person2#에게 과식 문제를 지적하고..."
```

#### 원인 분석

**Solar API/HF 보정이 제대로 작동하지 않은 경우**:
1. **Solar API 프롬프트 미흡**: 상황 인지 규칙이 명확하지 않음
2. **HF 모델의 한계**: 일부 모델이 여전히 A/B 사용
3. **앙상블 품질 판단 실패**: 낮은 품질의 결과가 선택됨

#### 해결 방안

**1. Solar API 프롬프트 강화** (`src/api/solar_api.py`):

```python
system_prompt = """당신은 대화 요약 전문가입니다. 다음 규칙을 엄격히 따라 대화를 요약하세요:

1. **핵심만 간결하게**: 원본 대화보다 짧게, 1-2문장으로 핵심만 요약

2. **상황 인지 명칭 변환** (매우 중요):
   - A/B, #Person1#/#Person2# 같은 플레이스홀더를 절대 사용하지 마세요
   - 대화 맥락과 말투를 분석하여 구체적 명칭으로 변환하세요

   분석 기준:
   a) 말투 분석:
      - 존댓말/격식체 → 고객/상담사, 의사/환자, 직원/관리자
      - 반말/비격식체 → 친구/친구, 연인/연인, 가족/가족

   b) 대화 내용 분석:
      - 업무/상담 → 고객/상담사, 직원/관리자
      - 의료 → 의사/환자
      - 교육 → 학생/교수, 학생/선생님
      - 일상 대화 → 친구/친구

   c) 명시된 이름 우선:
      - 대화 중 이름이 언급되면 해당 이름 사용
      - 예: "스티븐, 나 정말로 네 도움이 필요해" → "친구가 스티븐에게..."

3. **불필요한 접두사 제거**: "대화 요약:", "Summary:", "대화에서는" 등 제거

4. **함축적 표현**: 반복 없이 핵심 내용만

5. **길이 제한**: 반드시 원본 대화보다 짧게 작성"""
```

**2. 후처리 보완** (최후 수단):

A/B 패턴이 남아있는 경우 경고 로그 출력:

```python
def validate_summary(summary: str) -> bool:
    """요약문 품질 검증"""
    issues = []

    # A/B 패턴 검사
    if re.search(r'\b[A-D]\b', summary):
        issues.append("일반 명칭 사용 (A/B)")

    # #Person# 패턴 검사
    if re.search(r'#Person\d+#', summary):
        issues.append("#Person# 패턴 잔존")

    if issues:
        logger.warning(f"요약문 품질 문제: {', '.join(issues)}")
        return False

    return True
```

**예상 효과**: 8건 → 2-3건 (1.6% → 0.4-0.6%)

---

### 8.4 문제 3: 화자 명칭 오류 ⚠️ (78건, 15.6%)

**가장 심각한 문제**

#### 핵심 문제

**비격식 대화에 비즈니스 명칭 사용**:
- 친구/연인 대화에 "고객", "상담사" 사용
- 가족 대화에 "직원", "관리자" 사용

#### 상세 사례 분석

**test_1 (친구/연인 대화 → 잘못 "고객" 사용)**:

```
원본 대화:
#Person1#: 드디어 왔네! 뭐가 이렇게 오래 걸렸어?
#Person2#: 차가 또 막혔어. Carrefour 교차로 근처에서 교통체증이 엄청 심했거든.
#Person1#: 거긴 출퇴근 시간에 항상 혼잡하잖아. 집에 갈 때 다른 길 좀 찾아보는 게 어때?
...

문제점:
- 말투: 반말, 비격식체 ("야", "거든", "좀")
- 관계: 친구 또는 연인 관계
- 내용: 일상적인 교통 체증 대화

❌ 잘못된 요약:
"고객 B는 교통체증과 환경 문제로 인해 출퇴근 시 자동차 대신 대중교통이나
자전거를 이용하기로 결정했으며, 고객 A는 이러한 변화를 지지하고 있다."

✅ 올바른 요약 (기대):
"친구는 교통체증과 환경 문제로 인해 출퇴근 시 자동차 대신 대중교통이나
자전거를 이용하기로 결정했으며, 상대방은 이를 지지하고 있다."
```

**test_8 (친구 대화 + 명시된 이름 → 이름 활용 실패)**:

```
원본 대화:
#Person1#: 스티븐, 나 정말로 네 도움이 필요해.
#Person2#: 무슨 일이야?
#Person1#: 아내가 내 비서와 바람피운 걸 알아버렸어...

문제점:
- 말투: 반말, 친근한 호칭 ("스티븐", "네", "나")
- 관계: 친구
- 명시된 이름: "스티븐" (직접 언급됨)

❌ 현재 요약:
"친구 A가 친구 B에게 아내가 자신의 비서와 바람을 피운 사실을..."

✅ 올바른 요약 (기대):
"친구가 스티븐에게 아내가 자신의 비서와 바람을 피운 사실을..."
또는
"화자가 스티븐에게 아내의 외도 사실을 털어놓고 도움을 요청하자..."
```

**test_39 (학생-교수 대화 → 잘못 "고객" 사용)**:

```
원본 대화:
#Person1#: 들어오세요, 제가 도와드릴까요?
#Person2#: Turner 교수님, 다음 학기에 지질학 고급 과목 다시 하시나요?
#Person1#: 네, 맞아요.
#Person2#: 3학년인데 그 수업에 등록할 수 있을지 궁금해서요...

문제점:
- 말투: 존댓말 (학생 → 교수)
- 관계: 학생 - 교수
- 내용: 수업 등록 문의 (교육 관련)

❌ 현재 요약:
"고객인 B가 Turner 교수에게 다음 학기에 제공될 지질학 고급 과목에..."

✅ 올바른 요약 (기대):
"학생이 Turner 교수에게 다음 학기에 제공될 지질학 고급 과목에..."
또는
"3학년 학생이 Turner 교수에게..."
```

**test_312 (가족 대화 → 원본 + 요약 혼합, "고객/상담사" 오용)**:

```
원본 대화 (130자):
#Person1#: 나 중국에 관광하러 가고 싶어. 엄마, 어떻게 생각해?
#Person2#: 왜 안 되겠어? 중국은 정말 멋진 나라야.
#Person1#: 엄마도 같이 갈래?
#Person2#: 아쉽지만 지금은 못 가. 너무 바빠.

문제점 (복합):
1. 말투: 반말 (자녀 - 부모)
2. 명시: "엄마" 직접 언급
3. 관계: 가족 (자녀-부모)
4. 요약 실패: 원본 그대로 복사 + 잘못된 명칭 추가

❌ 현재 요약 (175자, 원본보다 김!):
"고객: 나 중국에 관광하러 가고 싶어. 엄마, 어떻게 생각해?
상담사: 왜 안 되겠어? 중국은 정말 멋진 나라야.
고객: 엄마도 같이 갈래?
상담사: 아쉽지만 지금은 못 가. 너무 바빠.

요약: 고객은 중국 관광을 제안하고, 상담사는 긍정적으로 반응하지만
자신은 바빠서 함께 가지 못한다고 합니다."

✅ 올바른 요약 (기대, ~50자):
"자녀가 엄마에게 중국 관광을 제안했으나, 엄마는 바쁘다는 이유로 동행할 수 없다고 답했다."
```

#### 근본 원인

**1. Solar API 프롬프트의 말투 분석 규칙 부재**:
- 현재: 단순히 "상황에 맞게 명칭 변환" (모호함)
- 문제: 말투(존댓말/반말) 분석 규칙 없음
- 결과: 모든 대화를 "고객/상담사"로 기본 설정

**2. 명시된 이름 추출 및 활용 규칙 부재**:
- 현재: 이름이 언급되어도 무시
- 문제: "스티븐", "엄마" 같은 호칭을 활용하지 않음

**3. 대화 맥락 분석 실패**:
- 현재: 키워드 기반 단순 판단
- 문제: 업무 키워드가 없으면 기본값 "고객/상담사" 사용

#### 해결 방안

**방법 1: Solar API 프롬프트 대폭 강화** (가장 효과적)

```python
# src/api/solar_api.py의 system_prompt 개선
system_prompt = """당신은 대화 요약 전문가입니다. 다음 규칙을 엄격히 따라 대화를 요약하세요:

1. **핵심만 간결하게**: 원본 대화보다 짧게, 1-2문장으로 핵심만 요약

2. **화자 관계 파악 및 명칭 변환** (최우선 규칙):

   STEP 1: 말투 분석
   - 반말/비격식체 감지:
     * 어미: ~해, ~야, ~거든, ~잖아, ~할래, ~좀
     * 호칭: 너, 니가, 네가
     → 판단: 친밀한 관계 (친구, 가족, 연인)

   - 존댓말/격식체 감지:
     * 어미: ~입니다, ~습니다, ~세요, ~시오, ~드립니다
     * 호칭: 손님, 고객님, 선생님
     → 판단: 공식 관계 (고객-상담사, 직원-손님, 의사-환자, 학생-교수)

   STEP 2: 명시된 이름/호칭 확인
   - "엄마", "아빠", "형", "언니" → 가족 관계
   - "스티븐", "마크" 등 이름 → 해당 이름 사용
   - "교수님", "선생님" → 교육 관계
   - "의사", "간호사" → 의료 관계

   STEP 3: 대화 내용 분석
   - 업무/계약/상담 → 고객/상담사
   - 진료/증상/처방 → 의사/환자
   - 수업/과제/성적 → 학생/교수
   - 일상/여가/개인사 → 친구/친구

   STEP 4: 명칭 결정 우선순위
   1순위: 명시된 이름/호칭 사용
   2순위: 말투 기반 관계 판단
   3순위: 내용 기반 관계 판단

   명칭 선택 예시:
   - 반말 + 일상 대화 → "친구", "상대방"
   - 반말 + "엄마" 언급 → "자녀", "엄마"
   - 존댓말 + 상담 내용 → "고객", "상담사"
   - 존댓말 + "교수님" 언급 → "학생", "교수"

3. **금지 사항**:
   - A/B, #Person1#/#Person2# 같은 플레이스홀더 절대 사용 금지
   - 말투와 맞지 않는 명칭 사용 금지 (예: 반말 대화에 "고객" 사용)
   - 원본 대화 그대로 복사 금지

4. **불필요한 접두사 제거**: "대화 요약:", "Summary:", "대화에서는" 등 제거

5. **길이 제한**: 반드시 원본 대화의 30-50% 길이로 요약"""
```

**방법 2: 후처리에서 검증 및 수정**

```python
def validate_speaker_names(summary: str, dialogue: str) -> tuple[bool, list[str]]:
    """화자 명칭 적절성 검증"""
    issues = []

    # 1. 말투 분석
    is_informal = bool(re.search(r'(야|너|니가|네가|해|해줘|그래|할래|거든|잖아)', dialogue))
    is_formal = bool(re.search(r'(입니다|습니다|세요|시오|하십시오|드립니다)', dialogue))

    # 2. 업무 키워드 확인
    has_business_context = bool(re.search(
        r'(회사|업무|직장|계약|거래|예약|체크아웃|상담|진료|수업|과제)',
        dialogue
    ))

    # 3. 비격식 대화에 비즈니스 명칭 사용 검사
    if is_informal and not is_formal and not has_business_context:
        if re.search(r'(고객|상담사|직원|관리자)', summary):
            issues.append(f"비격식 대화에 비즈니스 명칭 사용")

    # 4. 명시된 이름 활용 검사
    names_in_dialogue = re.findall(r'(엄마|아빠|형|언니|[A-Z][a-z]+님?)', dialogue)
    if names_in_dialogue:
        # 이름이 대화에 있는데 요약에 없으면 경고
        names_in_summary = re.findall(r'(엄마|아빠|형|언니|[A-Z][a-z]+님?)', summary)
        if not names_in_summary:
            issues.append(f"명시된 이름/호칭 미활용: {', '.join(set(names_in_dialogue[:3]))}")

    return len(issues) == 0, issues
```

**방법 3: Few-shot Learning 강화**

Solar API 호출 시 좋은 예시를 함께 제공:

```python
example_dialogue = """#Person1#: 야, 드디어 왔네!
#Person2#: 미안, 차가 막혔어."""

example_summary = """친구가 늦게 도착한 것에 대해 교통 체증을 이유로 설명했다."""
```

**예상 효과**: 78건 → 10-15건 (15.6% → 2-3%)

---

### 8.5 문제 4: 요약문이 원본보다 긴 경우 (1건, 0.2%)

**test_312** - 가장 심각한 실패 케이스

#### 상세 분석

```
원본 (130자):
#Person1#: 나 중국에 관광하러 가고 싶어. 엄마, 어떻게 생각해?
#Person2#: 왜 안 되겠어? 중국은 정말 멋진 나라야.
#Person1#: 엄마도 같이 갈래?
#Person2#: 아쉽지만 지금은 못 가. 너무 바빠.

요약 (175자, +45자 더 김!):
고객: 나 중국에 관광하러 가고 싶어. 엄마, 어떻게 생각해?
상담사: 왜 안 되겠어? 중국은 정말 멋진 나라야.
고객: 엄마도 같이 갈래?
상담사: 아쉽지만 지금은 못 가. 너무 바빠.

요약: 고객은 중국 관광을 제안하고, 상담사는 긍정적으로 반응하지만
자신은 바빠서 함께 가지 못한다고 합니다.
```

#### 복합 문제

1. **원본 대화 그대로 복사** + **잘못된 명칭 추가** (고객/상담사)
2. **추가로 요약문까지 붙임** (이중 요약)
3. **결과적으로 원본보다 45자 더 김**

#### 원인 분석

**Solar API/HF 모델 중 하나가 실패**:
- 원본 텍스트를 그대로 출력한 모델
- 앙상블 과정에서 품질 판단 실패
- 해당 결과가 최종 선택됨

#### 해결 방안

**1. 요약 품질 검증 강화**:

```python
def validate_summary_quality(summary: str, original: str) -> bool:
    """요약문 품질 검증"""
    # 1. 길이 검증
    if len(summary) > len(original):
        logger.warning(f"요약문이 원본보다 김: {len(summary)} > {len(original)}")
        return False

    # 2. 원본 복사 검증
    # 원본의 주요 문장이 그대로 포함되어 있는지 확인
    original_sentences = [s.strip() for s in original.split('.') if len(s.strip()) > 10]
    copied_count = sum(1 for sent in original_sentences if sent in summary)

    if copied_count >= len(original_sentences) * 0.5:
        logger.warning(f"원본 대화가 그대로 복사됨: {copied_count}/{len(original_sentences)} 문장")
        return False

    # 3. 이중 요약 패턴 검증
    if re.search(r'(고객|상담사|의사|환자):\s*[^.]+\.\s*요약:', summary):
        logger.warning("이중 요약 패턴 감지")
        return False

    return True
```

**2. Solar API 프롬프트에 길이 제한 강조**:

```python
system_prompt = """...

5. **길이 제한 (매우 중요)**:
   - 반드시 원본 대화의 30-50% 길이로 요약
   - 원본 대화 그대로 복사 절대 금지
   - 핵심만 추출하여 1-2문장으로 압축

   나쁜 예: [원본 대화를 그대로 복사한 후 "요약:" 추가]
   좋은 예: [핵심 내용만 1-2문장으로 간결하게]
"""
```

**3. 앙상블 품질 판단 기준 강화**:

```python
def calculate_summary_quality(summary: str, original: str) -> float:
    """요약문 품질 점수 계산"""
    score = 1.0

    # 길이 비율 페널티
    length_ratio = len(summary) / len(original)
    if length_ratio > 1.0:
        score *= 0.1  # 심각한 페널티
    elif length_ratio > 0.8:
        score *= 0.5
    elif 0.3 <= length_ratio <= 0.6:
        score *= 1.2  # 보너스

    # 원본 복사 페널티
    # ... (위와 동일)

    return score
```

**예상 효과**: 1건 → 0건 (0.2% → 0%)

---

### 8.6 종합 해결 방안 우선순위

#### Priority 1: 화자 명칭 오류 (78건, 15.6%) 🔴

**가장 시급한 문제**

1. Solar API 프롬프트 전면 개선 (말투 분석 규칙 추가)
2. 명시된 이름/호칭 활용 규칙 추가
3. Few-shot Learning 예시 강화
4. 후처리 검증 로직 추가

**예상 개선**: 78건 → 10-15건 (80% 감소)

#### Priority 2: 접두사 미제거 (3건, 0.6%) 🟢

**쉽게 해결 가능**

1. `src/inference/predictor.py`에 패턴 3개 추가
2. 즉시 적용 가능

**예상 개선**: 3건 → 0건 (100% 해결)

#### Priority 3: 일반 명칭 사용 (8건, 1.6%) 🟡

**Priority 1과 함께 해결**

1. Solar API 프롬프트 개선으로 대부분 해결
2. 후처리 검증으로 잔여 문제 잡기

**예상 개선**: 8건 → 2-3건 (70% 감소)

#### Priority 4: 요약문 길이 (1건, 0.2%) 🟡

**품질 검증 강화로 해결**

1. 앙상블 품질 판단 기준 강화
2. 원본 복사 패턴 검증 추가

**예상 개선**: 1건 → 0건 (100% 해결)

---

### 8.7 실행 계획

#### 단계 1: 긴급 수정 (즉시 적용 가능)

```bash
# 1. 접두사 패턴 추가 (predictor.py)
# 2. Git commit & push
# 3. 새로운 추론 실행
```

**예상 소요 시간**: 5분
**예상 효과**: 3건 해결

#### 단계 2: Solar API 프롬프트 개선 (핵심)

```bash
# 1. solar_api.py system_prompt 전면 개선
# 2. 말투 분석 규칙 추가
# 3. 명칭 우선순위 규칙 추가
# 4. Few-shot 예시 강화
# 5. Git commit & push
# 6. 새로운 추론 실행 (Solar API 사용)
```

**예상 소요 시간**: 30분
**예상 효과**: 78건 → 10-15건 (85% 개선)

#### 단계 3: 품질 검증 로직 추가

```bash
# 1. predictor.py에 검증 함수 추가
# 2. 앙상블 품질 판단 개선
# 3. Git commit & push
# 4. 새로운 추론 실행
```

**예상 소요 시간**: 20분
**예상 효과**: 1-2건 추가 개선

#### 최종 예상 결과

| 문제 유형 | 현재 | 개선 후 | 개선율 |
|----------|------|---------|--------|
| 접두사 미제거 | 3건 (0.6%) | 0건 (0%) | 100% |
| 일반 명칭 사용 | 8건 (1.6%) | 2-3건 (0.4-0.6%) | ~70% |
| 화자 명칭 오류 | 78건 (15.6%) | 10-15건 (2-3%) | ~85% |
| 길이 초과 | 1건 (0.2%) | 0건 (0%) | 100% |
| **전체** | **90건 (18.0%)** | **12-18건 (2.4-3.6%)** | **~85%** |

---

**작성일**: 2025-10-15
**최종 수정**: 2025-10-15 오전 (심층 분석 추가)
**상태**:
- ✅ 해결 완료: 기본 접두사 제거
- ⚠️ 개선 필요: 화자 명칭 오류 (최우선), 변형 접두사, 일반 명칭 사용
- 📊 분석 완료: 499개 샘플 전수 조사
