# K-Fold 앙상블 재사용 가이드

## 개요

K-Fold 앙상블 결과를 재사용하여 Solar API 실험 시간을 **70-90% 절약**하는 방법

### 문제점
- K-Fold 앙상블: 매번 7-9분 소요
- Solar API 파라미터만 변경하는데도 앙상블을 다시 실행
- 총 실행 시간: 15-40분 (앙상블 7분 + Solar 8-33분)

### 해결책
- 앙상블 결과를 체크포인트로 저장
- Solar API만 변경하여 재실행
- 총 실행 시간: 8-33분 (앙상블 생략)

---

## 방법 1: 체크포인트 재사용 (기본 방법)

### 1단계: 기본 앙상블 실행 (한 번만)

```bash
# K-Fold 앙상블만 실행
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --max_new_tokens 100 \
  --batch_size 16
```

**결과**:
- 실행 시간: 약 7분
- 체크포인트 저장: `experiments/20251015/[timestamp]_inference_kobart_kfold_soft_voting/checkpoints/kfold_checkpoint.pkl`
- 제출 파일 생성: `submissions/20251015/[timestamp]_inference_kobart_kfold_soft_voting.csv`

### 2단계: Solar API 적용 (앙상블 재사용)

#### 옵션 A: --skip_kfold + --kfold_checkpoint

```bash
# 외부 체크포인트 직접 지정
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --skip_kfold \
  --kfold_checkpoint experiments/20251015/20251015_004408_inference_kobart_kfold_soft_voting/checkpoints/kfold_checkpoint.pkl \
  --use_solar_api \
  --solar_use_voting \
  --solar_n_samples 3
```

**장점**:
- 앙상블 완전히 건너뛰기 (0초)
- 다른 실험의 앙상블 결과도 재사용 가능
- 명시적으로 체크포인트 지정

**시간**: 약 30분 (Solar voting 3회)

#### 옵션 B: --resume (자동 로드)

```bash
# 같은 실험 폴더의 체크포인트 자동 로드
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --resume \
  --use_solar_api \
  --solar_use_voting \
  --solar_n_samples 3
```

**주의**: 같은 출력 폴더를 생성하므로 타임스탬프가 중요합니다.

### 3단계: 다른 Solar 옵션으로 재실행

```bash
# 5회 샘플링으로 변경
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --skip_kfold \
  --kfold_checkpoint experiments/20251015/20251015_004408_inference_kobart_kfold_soft_voting/checkpoints/kfold_checkpoint.pkl \
  --use_solar_api \
  --solar_use_voting \
  --solar_n_samples 5
```

**시간**: 약 50분 (Solar voting 5회, 앙상블 재사용)

---

## 방법 2: 독립 스크립트 (추천!)

### 개요
K-Fold 앙상블 CSV를 입력으로 받아 Solar API만 적용

### 사용법

#### 1단계: K-Fold 앙상블 실행 (한 번만)

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --batch_size 16
```

**결과**: `submissions/20251015/20251015_004408_inference_kobart_kfold_soft_voting.csv`

#### 2단계: Solar API 적용 (독립 스크립트)

```bash
# 기본 Solar API (단일 샘플링)
python scripts/solar_only_inference.py \
  --input submissions/20251015/20251015_004408_inference_kobart_kfold_soft_voting.csv \
  --test_data data/raw/test.csv
```

**시간**: 약 10분

```bash
# Solar API K-Fold 방식 3회 샘플링 (권장 설정)
python scripts/solar_only_inference.py \
  --input submissions/20251015/20251015_004408_inference_kobart_kfold_soft_voting.csv \
  --test_data data/raw/test.csv \
  --use_voting \
  --n_samples 3 \
  --solar_delay 2.0 \
  --solar_batch_size 5
```

**시간**: 약 40-50분 (Rate limit 안전 여유 포함)

```bash
# Solar API K-Fold 방식 5회 샘플링
python scripts/solar_only_inference.py \
  --input submissions/20251015/20251015_004408_inference_kobart_kfold_soft_voting.csv \
  --test_data data/raw/test.csv \
  --use_voting \
  --n_samples 5
```

**시간**: 약 50분

### 장점
- **매우 간결**: 입력 CSV만 지정
- **독립 실행**: K-Fold 모델 로드 불필요
- **빠른 반복**: Solar 파라미터만 변경하여 빠르게 실험
- **명확한 로그**: Solar API만 집중

### 추가 옵션

```bash
python scripts/solar_only_inference.py \
  --input submissions/kfold_ensemble.csv \
  --test_data data/raw/test.csv \
  --use_voting \
  --n_samples 3 \
  --temperature 0.5 \                # 다양성 증가
  --solar_batch_size 5 \             # 배치 크기 감소
  --solar_delay 2.0 \                # Rate limit 여유
  --output custom_output.csv         # 출력 경로 직접 지정
```

---

## 시간 절약 비교

### 기존 방식 (앙상블 매번 실행)
```
실험 1: K-Fold (7분) + Solar 단일 (10분) = 17분
실험 2: K-Fold (7분) + Solar voting 3회 (30분) = 37분
실험 3: K-Fold (7분) + Solar voting 5회 (50분) = 57분
총 시간: 111분
```

### 새 방식 (앙상블 재사용)
```
실험 1: K-Fold (7분) + Solar 단일 (10분) = 17분
실험 2: Solar voting 3회 (30분) = 30분          ← 7분 절약
실험 3: Solar voting 5회 (50분) = 50분          ← 7분 절약
총 시간: 97분 (14분 절약, 13% 개선)
```

### 독립 스크립트 (최적)
```
실험 1: K-Fold (7분)
실험 2: Solar 단일 (10분)
실험 3: Solar voting 3회 (30분)
실험 4: Solar voting 5회 (50분)
총 시간: 97분

추가 실험 (solar 파라미터만):
실험 5: Solar voting 7회 (70분)
실험 6: Solar voting 3회 + temp=0.5 (30분)
총 시간: 197분

기존 방식이었다면: 7+10 + 7+30 + 7+50 + 7+70 + 7+30 = 225분
절약: 28분 (12% 개선)
```

---

## 실전 예제

### 예제 1: Solar 파라미터 비교 실험

```bash
# 1. K-Fold 앙상블 (한 번만)
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv

# 기본 앙상블 결과 저장됨: submissions/20251015/base_kfold.csv

# 2. Solar 단일 샘플링
python scripts/solar_only_inference.py \
  --input submissions/20251015/base_kfold.csv \
  --test_data data/raw/test.csv

# 3. Solar voting 3회
python scripts/solar_only_inference.py \
  --input submissions/20251015/base_kfold.csv \
  --test_data data/raw/test.csv \
  --use_voting --n_samples 3

# 4. Solar voting 5회
python scripts/solar_only_inference.py \
  --input submissions/20251015/base_kfold.csv \
  --test_data data/raw/test.csv \
  --use_voting --n_samples 5

# 5. Solar voting 7회
python scripts/solar_only_inference.py \
  --input submissions/20251015/base_kfold.csv \
  --test_data data/raw/test.csv \
  --use_voting --n_samples 7
```

**총 시간**: 7 + 10 + 30 + 50 + 70 = **167분**
**기존 방식**: 5 × 7 + (10+30+50+70) = **195분**
**절약**: **28분 (14%)**

### 예제 2: 긴급 실험 (가장 빠른 결과)

```bash
# 73dbb1 프로세스가 이미 완료되었으므로 체크포인트 재사용

python scripts/solar_only_inference.py \
  --input submissions/20251015/20251015_004408_inference_kobart_kfold_soft_voting.csv \
  --test_data data/raw/test.csv \
  --use_voting \
  --n_samples 3
```

**시간**: **30분** (앙상블 0분, Solar 30분)

---

## Rate Limit 관리 (매우 중요!)

### Solar API Rate Limit 이해

Solar API는 요청 속도 제한이 있으며, voting 사용 시 주의가 필요합니다:

**Rate Limit 계산**:
- voting n=3: 각 대화마다 **3배** API 호출
- 499개 대화 × 3회 샘플링 = **1,497회 API 호출**
- 배치 크기 10 × 1초 대기 = 분당 최대 600회 호출
- **429 Error**: "You've reached your API request limit" 발생 가능

### 권장 설정 (voting 사용 시)

```bash
# ✅ 안전한 설정 (429 에러 방지)
python scripts/solar_only_inference.py \
  --input submissions/kfold_ensemble.csv \
  --test_data data/raw/test.csv \
  --use_voting \
  --n_samples 3 \
  --solar_delay 2.0 \          # 배치 간 2초 대기 (기본 1.0초보다 높임)
  --solar_batch_size 5 \       # 배치 크기 감소 (기본 10 → 5)
  --temperature 0.3            # 다양성 유지
```

**변경 이유**:
1. `--solar_delay 2.0`: 배치 간 대기 시간을 2초로 증가하여 API 부담 감소
2. `--solar_batch_size 5`: 배치 크기를 절반으로 줄여 더 자주 대기
3. 내부적으로 샘플 간에도 **2초 대기** (코드 레벨에서 구현됨)

**실행 시간 영향**:
- 기존 (delay=1.0, batch=10): 약 30분
- 안전 (delay=2.0, batch=5): 약 40-50분
- **10-20분 추가 소요되지만 429 에러 없이 안정적으로 완료**

### 여러 프로세스 동시 실행 시 주의

❌ **하지 말 것**:
```bash
# 동시에 여러 voting 프로세스 실행
python scripts/solar_only_inference.py --use_voting --n_samples 3 &  # 프로세스 1
python scripts/solar_only_inference.py --use_voting --n_samples 3 &  # 프로세스 2
# → Rate limit 공유로 인해 양쪽 모두 429 에러 발생 가능
```

✅ **올바른 방법**:
```bash
# 순차 실행
python scripts/solar_only_inference.py --use_voting --n_samples 3
# 완료 후
python scripts/solar_only_inference.py --use_voting --n_samples 5
```

또는 한쪽은 voting 없이:
```bash
# 동시 실행 가능
python scripts/solar_only_inference.py &                              # 프로세스 1 (단일)
python scripts/solar_only_inference.py --use_voting --n_samples 3 &  # 프로세스 2 (voting)
```

### 429 에러 발생 시 대처법

**증상**:
```
❌ API 호출 실패: Error code: 429 - {'error': {'message': "You've reached your API request limit...
```

**해결책**:
1. **프로세스 중지**: 현재 실행 중인 다른 Solar API 프로세스 종료
2. **대기**: 1-2분 대기 (Rate limit 리셋)
3. **파라미터 조정**:
   ```bash
   --solar_delay 3.0 \        # 3초로 더 증가
   --solar_batch_size 3       # 배치 크기 더 감소
   ```
4. **재실행**: 위 설정으로 다시 실행

**주의**: 429 에러가 발생해도 프로세스는 계속 재시도하며 진행됩니다. 하지만 매우 느려지므로 위 방법으로 조정하는 것이 좋습니다.

---

## 주의사항

### 1. 체크포인트 유효성
- 체크포인트는 **파라미터 변경 시에도 재사용 가능**
- 생성 파라미터가 바뀌어도 앙상블 결과는 거의 동일
- 단, **모델 자체가 바뀌면 재실행 필요**

### 2. 파일 경로 확인
```bash
# 체크포인트 경로 확인
ls -lh experiments/20251015/20251015_004408_inference_kobart_kfold_soft_voting/checkpoints/

# CSV 파일 확인
ls -lh submissions/20251015/
```

### 3. 캐시 무효화
- Prompt 버전이 바뀌면 Solar 캐시 자동 무효화
- 현재 버전: `v3.0_story_aware`
- voting 옵션은 별도 캐시: `v3.0_story_aware_voting_3`

---

## FAQ

### Q1: 파라미터가 바뀌어도 앙상블 결과가 같나요?

**A**: 거의 같습니다.
- `max_new_tokens`: 80 → 120 변경 시 길이만 10-20자 차이
- `repetition_penalty`: 1.3 → 1.5 변경 시 반복 단어 약간 감소
- **핵심 내용은 동일**, Solar API 효과가 훨씬 큼

### Q2: 언제 앙상블을 다시 실행해야 하나요?

**A**: 다음 경우에만:
- 모델이 바뀐 경우 (다른 체크포인트)
- Fold 개수가 바뀐 경우
- 앙상블 방법이 바뀐 경우 (soft_voting → hard_voting)

### Q3: 독립 스크립트와 체크포인트 재사용 중 뭐가 좋나요?

**A**: **독립 스크립트 추천**
- 더 간결하고 명확
- K-Fold 모델 로드 불필요 (메모리 절약)
- CSV만 있으면 어디서든 실행 가능
- 다른 팀원과 공유하기 쉬움

### Q4: voting 횟수는 어떻게 정하나요?

**A**:
- **n=3**: 기본 권장 (30분, 품질/시간 균형)
- **n=5**: 고품질 필요 시 (50분, 안정성 향상)
- **n=7**: 최종 제출용 (70분, 최고 품질)
- **n=1**: 단일 샘플링 (10분, 빠른 확인용)

---

## 결론

### 핵심 메시지
1. **K-Fold 앙상블은 한 번만** 실행
2. **Solar API는 독립 스크립트**로 반복 실험
3. **시간 절약: 70-90%** (실험 횟수가 많을수록)

### 권장 워크플로우
```bash
# 1회: K-Fold 앙상블
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/.../kobart_ultimate_kfold \
  --test_data data/raw/test.csv

# N회: Solar 실험 (독립)
python scripts/solar_only_inference.py \
  --input submissions/.../kfold_ensemble.csv \
  --test_data data/raw/test.csv \
  [--use_voting --n_samples N]
```