# 체크포인트 재사용 명령어 가이드

K-Fold 앙상블 추론 파이프라인에서 체크포인트를 재사용하여 특정 단계부터 이어서 실행하는 방법을 안내합니다.

---

## 📂 체크포인트 파일 구조

각 실험 폴더의 `checkpoints/` 디렉토리에는 다음과 같은 파일들이 저장됩니다:

```
experiments/{날짜}/{실험명}/checkpoints/
├── kfold_checkpoint.pkl              # K-Fold 앙상블 결과 (pickle)
├── kfold_summaries.csv               # K-Fold 앙상블 결과 (CSV)
├── hf_correction_checkpoint.pkl      # HuggingFace 보정 결과 (pickle)
├── hf_correction_summaries.csv       # HuggingFace 보정 결과 (CSV)
├── solar_api_checkpoint.pkl          # Solar API 앙상블 결과 (pickle)
└── solar_api_summaries.csv           # Solar API 앙상블 결과 (CSV)
```

---

## 🎯 사용 시나리오

### 시나리오 1: K-Fold 완료 → Solar API만 실행

**상황**: K-Fold 앙상블은 이미 완료했고, Solar API 앙상블만 추가로 실행하고 싶을 때

**예시 실험 폴더**: `experiments/20251015/20251015_130751_inference_kobart_kfold_soft_voting_bs32_maxnew110_hf_solar`

#### 명령어 (solar-1-mini-chat - 권장)

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --kfold_checkpoint experiments/20251015/20251015_130751_inference_kobart_kfold_soft_voting_bs32_maxnew110_hf_solar/checkpoints/kfold_checkpoint.pkl \
  --skip_kfold \
  --use_solar_api \
  --solar_model solar-1-mini-chat \
  --solar_temperature 0.1 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --solar_delay 3.0 \
  --max_new_tokens 110 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

**예상 시간**: 약 2-3시간 (499개 샘플, 5회 샘플링 기준)

---

#### 명령어 (solar-pro2 - 최고 품질)

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --kfold_checkpoint experiments/20251015/20251015_130751_inference_kobart_kfold_soft_voting_bs32_maxnew110_hf_solar/checkpoints/kfold_checkpoint.pkl \
  --skip_kfold \
  --use_solar_api \
  --solar_model solar-pro2 \
  --solar_temperature 0.1 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --solar_delay 3.0 \
  --max_new_tokens 110 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

**예상 시간**: 약 4-5시간 (499개 샘플, 5회 샘플링 기준)

---

### 시나리오 2: HuggingFace 보정까지 완료 → Solar API만 실행

**상황**: K-Fold 앙상블 + HuggingFace 보정까지 완료했고, Solar API만 추가로 실행하고 싶을 때

#### 명령어

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --kfold_checkpoint experiments/20251015/20251015_130751_inference_kobart_kfold_soft_voting_bs32_maxnew110_hf_solar/checkpoints/hf_correction_checkpoint.pkl \
  --skip_kfold \
  --use_solar_api \
  --solar_model solar-1-mini-chat \
  --solar_temperature 0.1 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --solar_delay 3.0 \
  --max_new_tokens 110 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

**차이점**: `hf_correction_checkpoint.pkl` 사용 → HuggingFace 보정 결과부터 시작

---

### 시나리오 3: Solar API 중단 후 재개

**상황**: Solar API 실행 중 중단되어 이어서 실행하고 싶을 때

#### 명령어

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --use_solar_api \
  --solar_model solar-1-mini-chat \
  --solar_temperature 0.1 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --solar_delay 3.0 \
  --max_new_tokens 110 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

**참고**:
- `--resume` 플래그만 사용
- 자동으로 마지막 체크포인트부터 재개
- 동일한 실험 폴더에서 실행해야 함

---

### 시나리오 4: K-Fold만 실행 (Solar API/HuggingFace 제외)

**상황**: K-Fold 앙상블만 빠르게 실행하고 싶을 때

#### 명령어

```bash
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --max_new_tokens 110 \
  --min_new_tokens 30 \
  --num_beams 5 \
  --length_penalty 1.0 \
  --repetition_penalty 1.5 \
  --no_repeat_ngram_size 3 \
  --batch_size 16 \
  --ensemble_method soft_voting \
  --resume
```

**특징**:
- `--use_solar_api` 없음 → Solar API 건너뜀
- `--use_pretrained_correction` 없음 → HuggingFace 보정 건너뜀
- K-Fold 앙상블 결과가 바로 제출 파일로 저장

---

## 🔑 핵심 옵션 설명

### 1. 체크포인트 재사용 옵션

| 옵션 | 설명 | 예시 |
|------|------|------|
| `--kfold_checkpoint` | 재사용할 K-Fold 체크포인트 경로 | `experiments/.../checkpoints/kfold_checkpoint.pkl` |
| `--skip_kfold` | K-Fold 앙상블 건너뛰기 (체크포인트 필수) | 플래그 |
| `--resume` | 이어서 실행 (자동 체크포인트 감지) | 플래그 |

### 2. Solar API 옵션

| 옵션 | 설명 | 권장값 | 비고 |
|------|------|--------|------|
| `--solar_model` | Solar 모델 선택 | `solar-1-mini-chat` | `solar-pro2`는 느림 |
| `--solar_temperature` | 생성 온도 (낮을수록 일관성) | `0.1` | v3.5 최적화값 |
| `--solar_use_voting` | 다중 샘플링 사용 | 플래그 | 품질 향상 |
| `--solar_n_samples` | 샘플링 횟수 | `5` | 3-5회 권장 |
| `--solar_delay` | 배치 간 대기 시간 (초) | `3.0` | Rate limit 방지 |

### 3. 생성 파라미터

| 옵션 | 설명 | 권장값 |
|------|------|--------|
| `--max_new_tokens` | 생성할 최대 토큰 수 | `110` |
| `--min_new_tokens` | 생성할 최소 토큰 수 | `30` |
| `--num_beams` | Beam search 빔 개수 | `5` |
| `--length_penalty` | 길이 페널티 | `1.0` |
| `--repetition_penalty` | 반복 억제 강도 | `1.5` |
| `--no_repeat_ngram_size` | 반복 금지 n-gram 크기 | `3` |

---

## 📊 모델별 성능 및 시간 비교

| 모델 | 품질 | 속도 | 예상 시간 (499개, 5회 샘플링) | 비고 |
|------|------|------|-------------------------------|------|
| `solar-1-mini-chat` | ⭐⭐⭐⭐ | ⚡⚡⚡ | 2-3시간 | **권장** - 품질/속도 균형 |
| `solar-pro2` | ⭐⭐⭐⭐⭐ | ⚡ | 4-5시간 | 최고 품질, 매우 느림 |
| KoBART만 | ⭐⭐⭐ | ⚡⚡⚡⚡⚡ | 10-15분 | Solar 없이 빠른 테스트 |

---

## 🛠️ 체크포인트 확인 방법

### 1. 체크포인트 파일 존재 확인

```bash
# K-Fold 체크포인트
ls -lh experiments/20251015/20251015_130751_*/checkpoints/kfold_checkpoint.pkl

# HuggingFace 체크포인트
ls -lh experiments/20251015/20251015_130751_*/checkpoints/hf_correction_checkpoint.pkl

# Solar API 체크포인트
ls -lh experiments/20251015/20251015_130751_*/checkpoints/solar_api_checkpoint.pkl
```

### 2. CSV 파일로 진행 상황 확인

```bash
# K-Fold 결과 확인
head experiments/20251015/20251015_130751_*/checkpoints/kfold_summaries.csv

# HuggingFace 보정 결과 확인
head experiments/20251015/20251015_130751_*/checkpoints/hf_correction_summaries.csv

# Solar API 결과 확인
head experiments/20251015/20251015_130751_*/checkpoints/solar_api_summaries.csv
```

### 3. 요약 개수 확인

```bash
# CSV 파일 라인 수 확인 (헤더 제외하면 -1)
wc -l experiments/20251015/20251015_130751_*/checkpoints/*.csv
```

**정상 출력 예시**:
```
500 kfold_summaries.csv         # 1 (헤더) + 499 (데이터)
500 hf_correction_summaries.csv
500 solar_api_summaries.csv
```

---

## ⚠️ 주의사항

### 1. 체크포인트 경로 확인
- **절대 경로** 또는 **정확한 상대 경로** 사용
- 실험 폴더명에 타임스탬프가 포함되므로 주의

### 2. 파라미터 일관성
- 체크포인트와 **동일한 generation 파라미터** 권장
- 다른 파라미터 사용 시 일관성 저하 가능

### 3. Resume vs 체크포인트 재사용
| 방법 | 사용 시점 | 새 실험 폴더 | 체크포인트 경로 |
|------|-----------|--------------|----------------|
| `--resume` | 같은 실험 이어서 실행 | ❌ 동일 폴더 | 자동 감지 |
| `--kfold_checkpoint` + `--skip_kfold` | 다른 실험에서 K-Fold 재사용 | ✅ 새 폴더 생성 | 수동 지정 |

### 4. Solar API Rate Limit
- v3.5에서 **자동 재시도 로직** 추가
- 429 에러 발생 시 5초 → 10초 → 20초 대기 후 재시도
- 안정적으로 실행 가능

---

## 🎯 실전 예시

### 예시 1: 빠른 프로토타이핑

```bash
# 1단계: K-Fold만 빠르게 실행
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --max_new_tokens 110 \
  --batch_size 16 \
  --resume

# 2단계: 결과 확인 후 Solar API 추가 (체크포인트 재사용)
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --kfold_checkpoint experiments/20251015/{생성된폴더}/checkpoints/kfold_checkpoint.pkl \
  --skip_kfold \
  --use_solar_api \
  --solar_model solar-1-mini-chat \
  --solar_use_voting \
  --solar_n_samples 3 \
  --resume
```

### 예시 2: 고품질 최종 제출

```bash
# K-Fold + HuggingFace + Solar Pro2 (최고 품질)
python scripts/kfold_ensemble_inference.py \
  --experiment_dir experiments/20251014/20251014_183206_kobart_ultimate_kfold \
  --test_data data/raw/test.csv \
  --use_pretrained_correction \
  --correction_models gogamza/kobart-base-v2 digit82/kobart-summarization \
  --use_solar_api \
  --solar_model solar-pro2 \
  --solar_temperature 0.1 \
  --solar_use_voting \
  --solar_n_samples 5 \
  --max_new_tokens 110 \
  --batch_size 16 \
  --resume
```

### 예시 3: A/B 테스트 (모델 비교)

```bash
# A안: solar-1-mini-chat
python scripts/kfold_ensemble_inference.py \
  --kfold_checkpoint {체크포인트경로} \
  --skip_kfold \
  --use_solar_api \
  --solar_model solar-1-mini-chat \
  --solar_n_samples 5 \
  --resume

# B안: solar-pro2
python scripts/kfold_ensemble_inference.py \
  --kfold_checkpoint {체크포인트경로} \
  --skip_kfold \
  --use_solar_api \
  --solar_model solar-pro2 \
  --solar_n_samples 5 \
  --resume
```

---

## 📚 관련 문서

- **Solar API 최적화**: `docs/issues/Solar_API_Rate_Limit_및_이름패턴_수정_v3.5.md`
- **프롬프트 엔지니어링**: `docs/issues/Solar_API_플레이스홀더_제거_v2.md`
- **실험 명령어 검증**: `docs/usage/명령어_검증_solar_pro2.md`
- **CSV 체크포인트 기능**: 커밋 `16f31c7`

---

## 💡 팁

1. **개발 단계**: `solar-1-mini-chat` + `n_samples=3` (빠른 테스트)
2. **최종 제출**: `solar-pro2` + `n_samples=5` (최고 품질)
3. **중단 가능성 높을 때**: `--resume` 항상 사용
4. **CSV로 진행 확인**: `checkpoints/*.csv` 파일 주기적으로 확인
5. **Rate Limit 걱정 없음**: v3.5 자동 재시도 로직 내장
